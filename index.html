<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExploreMeet Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS RESET & VARIABLES --- */
        :root { --primary: #4176FA; --danger: #ef4444; --bg: #F0F2F5; --text: #333; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg); overflow: hidden; }

        /* --- 1. LANDING PAGE (Initial Screen) --- */
        #landing-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; color: white; text-align: center;
        }
        .landing-content h1 { font-size: 3rem; margin-bottom: 10px; font-weight: 800; letter-spacing: 2px; }
        .landing-content p { font-size: 1.2rem; margin-bottom: 40px; opacity: 0.9; }
        .google-login-btn {
            background: white; color: #333; border: none; padding: 15px 30px;
            font-size: 1.1rem; font-weight: bold; border-radius: 30px; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .google-login-btn:active { transform: scale(0.95); }

        /* --- 2. MAIN APP INTERFACE (Hidden Initially) --- */
        #app-interface { display: none; height: 100%; flex-direction: column; }

        /* Header */
        .header {
            background: white; height: 60px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; z-index: 100;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

        /* Screens Container */
        .screen-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .screen { display: none; flex-direction: column; align-items: center; animation: fadeIn 0.3s ease; }
        .active-screen { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Home Screen UI */
        .hero-card {
            width: 100%; max-width: 400px; border-radius: 20px; overflow: hidden; position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 30px;
        }
        /* --- FIXED IMAGE LINK BELOW --- */
        .hero-img { width: 100%; display: block; }
        .hero-text { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: white; padding: 20px; text-align: center; }
        
        .join-btn {
            width: 100%; max-width: 300px; padding: 18px; border-radius: 15px; border: none;
            background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(65, 118, 250, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Profile Screen UI */
        .profile-card {
            background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        .profile-pic { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary); margin-bottom: 15px; }
        .profile-name { font-size: 1.4rem; font-weight: bold; color: #333; }
        .profile-email { color: #666; margin-bottom: 30px; }
        
        .logout-btn {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--danger);
            background: transparent; color: var(--danger); font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--danger); color: white; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; align-items: center; z-index: 90;
        }
        .nav-item { color: #aaa; font-size: 1.4rem; cursor: pointer; padding: 10px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }

        /* --- 3. GENDER & VIDEO OVERLAYS (Professional & Fixed) --- */
        #gender-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white;
            z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .gender-options { display: flex; gap: 20px; margin-top: 30px; }
        .gender-card {
            width: 140px; height: 180px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .gender-card:active { transform: scale(0.95); }
        .male { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .female { background: linear-gradient(135deg, #ec4899, #db2777); }
        .gender-card i { font-size: 3rem; margin-bottom: 15px; }

        /* Video Container - STRICT FIX */
        #video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
        }

        #matching-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98);
            z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="landing-screen">
        <div class="landing-content">
            <h1>EXPLOREMEET</h1>
            <p>Connect with the world instantly.</p>
            <button class="google-login-btn" onclick="handleLogin()">
                <i class="fab fa-google"></i> Login / Sign Up with Google
            </button>
        </div>
    </div>

    <div id="app-interface">
        
        <div class="header">
            <div class="logo">ExploreMeet</div>
        </div>

        <div class="screen-container">
            
            <div id="screen-home" class="screen active-screen">
                <div class="hero-card">
                    <img src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?q=80&w=1000&auto=format&fit=crop" class="hero-img" alt="Video Chat">
                    <div class="hero-text">
                        <h3>Start Matching</h3>
                        <p>Video chat with random people</p>
                    </div>
                </div>
                <button class="join-btn" onclick="openGenderScreen()">
                    <i class="fas fa-video"></i> Start Video Match
                </button>
            </div>

            <div id="screen-messages" class="screen">
                <div style="text-align: center; margin-top: 50px; color: #888;">
                    <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 20px; color: #ddd;"></i>
                    <h3>No Messages</h3>
                    <p>Chat history will appear here.</p>
                </div>
            </div>

            <div id="screen-profile" class="screen">
                <div class="profile-card">
                    <img id="user-img" src="" class="profile-pic">
                    <h2 id="user-name" class="profile-name">User</h2>
                    <p id="user-email" class="profile-email">email@example.com</p>
                    
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="switchTab('messages')"><i class="fas fa-comment-alt"></i></div>
            <div class="nav-item" onclick="switchTab('profile')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <div id="gender-screen">
        <h2 style="font-size: 1.8rem; margin-bottom: 10px;">Who to match?</h2>
        <p style="color: #666;">Select preference to start call</p>
        <div class="gender-options">
            <div class="gender-card male" onclick="selectGender('male')">
                <i class="fas fa-mars"></i> <span>Male</span>
            </div>
            <div class="gender-card female" onclick="selectGender('female')">
                <i class="fas fa-venus"></i> <span>Female</span>
            </div>
        </div>
        <button onclick="closeGenderScreen()" style="margin-top: 40px; background: transparent; border: none; color: #888; text-decoration: underline; cursor: pointer;">Cancel</button>
    </div>

    <div id="matching-overlay">
        <div class="loader"></div>
        <h3 style="margin-top: 20px;">Finding a partner...</h3>
    </div>

    <div id="video-container"></div>


    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, push, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            storageBucket: "exploremeet---live.firebasestorage.app",
            messagingSenderId: "169038218786",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        let currentUser = null;

        // --- 1. AUTH STATE LISTENER (Controls Landing Page vs App) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // LOGGED IN
                currentUser = user;
                document.getElementById('landing-screen').style.display = 'none'; // Hide Landing
                document.getElementById('app-interface').style.display = 'flex';  // Show App
                
                // Update Profile Data
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-img').src = user.photoURL;
            } else {
                // NOT LOGGED IN
                currentUser = null;
                document.getElementById('landing-screen').style.display = 'flex'; // Show Landing
                document.getElementById('app-interface').style.display = 'none';  // Hide App
            }
        });

        // --- 2. BUTTON ACTIONS ---
        window.handleLogin = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (e) {
                alert("Login Error: " + e.message);
            }
        };

        window.handleLogout = () => {
            signOut(auth);
            // onAuthStateChanged will automatically show Landing Page
        };

        window.switchTab = (tab) => {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById('screen-' + tab).classList.add('active-screen');
            
            // Highlight Icon
            const index = tab === 'home' ? 0 : tab === 'messages' ? 1 : 2;
            document.querySelectorAll('.nav-item')[index].classList.add('active');
        };

        // --- 3. VIDEO FLOW ---
        window.openGenderScreen = () => {
            document.getElementById('gender-screen').style.display = 'flex';
        };

        window.closeGenderScreen = () => {
            document.getElementById('gender-screen').style.display = 'none';
        };

        window.selectGender = (gender) => {
            document.getElementById('gender-screen').style.display = 'none';
            document.getElementById('matching-overlay').style.display = 'flex';
            startMatchingLogic();
        };

        async function startMatchingLogic() {
            const queueRef = ref(db, 'queue');
            const snapshot = await get(queueRef);
            let matchFound = false;

            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    if (!matchFound && child.val().uid !== currentUser.uid) {
                        matchFound = true;
                        const roomID = child.key;
                        set(ref(db, `queue/${child.key}/matchedWith`), currentUser.uid);
                        initVideoCall(roomID);
                    }
                });
            }

            if (!matchFound) {
                const myRef = push(queueRef);
                set(myRef, { uid: currentUser.uid, matchedWith: "" });
                
                onValue(myRef, (snap) => {
                    if (snap.val()?.matchedWith) {
                        initVideoCall(myRef.key);
                        setTimeout(() => remove(myRef), 3000);
                    }
                });
                onDisconnect(myRef).remove();
            }
        }

        function initVideoCall(roomID) {
            document.getElementById('matching-overlay').style.display = 'none';
            const videoContainer = document.getElementById('video-container');
            videoContainer.style.display = 'block';

            const appID = 2013687880; 
            const serverSecret = "2576346c100ee42b720e88db26d01e53";
            
            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(
                appID, serverSecret, roomID, currentUser.uid, currentUser.displayName
            );

            const zp = ZegoUIKitPrebuilt.create(kitToken);
            zp.joinRoom({
                container: videoContainer,
                scenario: { mode: ZegoUIKitPrebuilt.OneONoneCall },
                showPreJoinView: false,
                onLeaveRoom: () => {
                    videoContainer.style.display = 'none'; // Hide video container properly
                    location.reload(); // Refresh to clean state
                }
            });
        }
    </script>
</body>
</html>
