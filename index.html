<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExploreMeet - Dating App</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ZegoCloud UI Kit -->
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>

    <style>
        :root {
            --primary: #ff3366; /* Neon Pink */
            --secondary: #ffd700; /* Gold */
            --bg-dark: #0f0c29;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-gradient);
            color: var(--text-white);
            height: 100vh;
            overflow: hidden; /* Prevent scrolling on main body */
            position: relative;
        }

        /* --- Animations --- */
        @keyframes floatHeart {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-10vh) scale(1.2); opacity: 0; }
        }

        .heart-bg {
            position: absolute;
            color: rgba(255, 51, 102, 0.3);
            animation: floatHeart 10s linear infinite;
            z-index: 0;
            user-select: none;
        }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            background: var(--bg-gradient);
        }

        .logo-area {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .logo-area h1 {
            font-size: 2.5rem;
            background: -webkit-linear-gradient(var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .btn-grad {
            background-image: linear-gradient(to right, #DA22FF 0%, #9733EE  51%, #DA22FF  100%);
            margin: 10px;
            padding: 15px 45px;
            text-align: center;
            text-transform: uppercase;
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 0 20px #eee;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-grad:hover { background-position: right center; color: #fff; text-decoration: none; }

        /* --- Main App UI --- */
        #app-screen {
            display: none;
            height: 100%;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        .vip-badge {
            background: var(--secondary);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            display: none;
        }

        /* --- Content Sections --- */
        .content-section {
            display: none;
            padding: 20px;
            height: calc(100vh - 140px); /* adjust for header + nav + ads */
            overflow-y: auto;
            text-align: center;
        }

        .content-section.active { display: block; }

        /* Cards */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .match-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary) 0%, #000 100%);
            border: 4px solid var(--secondary);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 30px var(--primary);
            animation: pulse 2s infinite;
            margin-top: 50px;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 51, 102, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 51, 102, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 51, 102, 0); }
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed;
            bottom: 50px; /* Space for Ad */
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(15, 12, 41, 0.95);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--glass-border);
        }

        .nav-item {
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .nav-item.active { color: var(--primary); transform: translateY(-5px); }

        /* --- Ad Container --- */
        #ad-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #555;
            font-size: 0.8rem;
            border-top: 1px solid #333;
            z-index: 999;
        }

        /* --- Teddy Bear --- */
        #teddy-mascot {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 70px;
            height: 70px;
            font-size: 50px;
            text-align: center;
            line-height: 70px;
            cursor: pointer;
            z-index: 900;
            filter: drop-shadow(0 0 10px rgba(255,215,0,0.5));
            animation: bounce 3s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        /* --- Video & Overlays --- */
        #video-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
        }

        #friend-req-btn-video {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001; /* Above Zego */
            padding: 10px 20px;
            background: var(--primary);
            border-radius: 30px;
            color: white;
            border: none;
            display: none; /* Show when video active */
        }

        #next-match-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2002;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .avatar-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 10px; }
        
        /* Friend List */
        .friend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .status-text { margin-top: 10px; font-size: 1.2rem; color: var(--secondary); }

    </style>
</head>
<body>

    <!-- Background Hearts -->
    <div id="hearts-container"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="logo-area">
            <h1>ExploreMeet</h1>
            <p>Find Love in the Metaverse</p>
        </div>
        <button class="btn-grad" id="login-btn">
            <i class="fab fa-google"></i> Login with Google
        </button>
    </div>

    <!-- Application Screen -->
    <div id="app-screen">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="user-avatar-top" src="" style="width:35px; height:35px; border-radius:50%;" alt="User">
                <span id="header-vip" class="vip-badge">VIP</span>
            </div>
            <h3 style="color:var(--primary);">ExploreMeet</h3>
            <button onclick="logout()" style="background:none; border:none; color:white;"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <!-- Teddy Mascot -->
        <div id="teddy-mascot">ðŸ§¸</div>

        <!-- Sections -->
        <main>
            <!-- Home: Matching -->
            <section id="home" class="content-section active">
                <div class="glass-card">
                    <h2>Ready to Mingle?</h2>
                    <p>Click below to start a video chat with a random stranger.</p>
                </div>
                <button id="start-match-btn" class="match-btn">Find<br>Match</button>
                <div id="match-status" style="margin-top:20px; min-height: 20px;"></div>
            </section>

            <!-- Friends -->
            <section id="friends" class="content-section">
                <h2>Your Connections</h2>
                <div id="friends-list" style="margin-top:20px;">
                    <!-- Friend items loaded here -->
                    <p style="opacity:0.6">No friends yet. Start matching!</p>
                </div>
            </section>

            <!-- Profile -->
            <section id="profile" class="content-section">
                <div class="glass-card">
                    <img id="profile-img" src="" class="avatar-img">
                    <h2 id="profile-name">User Name</h2>
                    <p id="profile-email" style="font-size:0.8rem; opacity:0.7;"></p>
                    <div id="vip-status-display" style="margin: 15px 0; color: var(--secondary);">Free Member</div>
                    
                    <button id="buy-vip-btn" class="btn-grad" style="background-image: linear-gradient(to right, #FDC830 0%, #F37335 51%, #FDC830 100%);">
                        <i class="fas fa-crown"></i> Buy VIP ($9.99)
                    </button>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="switchTab('friends')"><i class="fas fa-user-friends"></i></div>
            <div class="nav-item" onclick="switchTab('profile')"><i class="fas fa-user"></i></div>
        </div>

        <!-- Ad Container -->
        <div id="ad-container">
            [AdMob Banner Space - Buy VIP to Hide]
        </div>
    </div>

    <!-- Video Call Layer -->
    <div id="video-layer"></div>
    <button id="friend-req-btn-video" onclick="sendFriendRequest()"><i class="fas fa-user-plus"></i> Add Friend</button>

    <!-- Next Match Overlay -->
    <div id="next-match-overlay">
        <h2 style="margin-bottom:20px;">Match Ended</h2>
        <div style="display:flex; gap:20px;">
            <button class="btn-grad" onclick="findNextMatch()">Find Next</button>
            <button class="btn-grad" style="background-image: linear-gradient(to right, #434343 0%, black 100%);" onclick="closeVideoOverlay()">Go Home</button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Import Firebase v10
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update, onValue, push, child, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            storageBucket: "exploremeet---live.firebasestorage.app",
            messagingSenderId: "169038218786",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const ZEGO_APP_ID = 2013687880;
        const ZEGO_SERVER_SECRET = "2576346c100ee42b720e88db26d01e53";

        // --- INIT FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let zegoInstance = null;
        let currentRoomId = null;
        let currentMatchUid = null;

        // --- UI & ANIMATION LOGIC ---
        function createHearts() {
            const container = document.getElementById('hearts-container');
            setInterval(() => {
                const heart = document.createElement('div');
                heart.classList.add('heart-bg');
                heart.innerHTML = 'â¤ï¸';
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.fontSize = (Math.random() * 20 + 10) + 'px';
                heart.style.animationDuration = (Math.random() * 5 + 5) + 's';
                container.appendChild(heart);
                setTimeout(() => heart.remove(), 10000);
            }, 500);
        }
        createHearts();

        window.switchTab = (tabId) => {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            
            // Highlight nav icon
            if(tabId === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(tabId === 'friends') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(tabId === 'profile') document.querySelectorAll('.nav-item')[2].classList.add('active');
        };

        // --- TEDDY BEAR LOGIC ---
        const teddy = {
            speak: (text) => {
                if (!window.speechSynthesis) return;
                
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = window.speechSynthesis.getVoices();
                // Try to find an Indian English voice or Hindi voice
                const voice = voices.find(v => v.lang.includes('IN') || v.lang.includes('hi'));
                if(voice) utterance.voice = voice;
                
                utterance.rate = 1;
                utterance.pitch = 1.2;
                window.speechSynthesis.speak(utterance);
            }
        };

        document.getElementById('teddy-mascot').addEventListener('click', () => {
            teddy.speak("Main hoon Teddy! Kaise ho aap?");
        });

        // --- AUTH LOGIC ---
        const loginBtn = document.getElementById('login-btn');
        loginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert(err.message));
        });

        window.logout = () => {
            signOut(auth);
            window.location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check Ban Status
                const userRef = ref(db, 'users/' + user.uid);
                const snapshot = await get(userRef);
                const userData = snapshot.val();

                if (userData && userData.isBanned) {
                    alert("You are Banned from ExploreMeet.");
                    signOut(auth);
                    return;
                }

                currentUser = user;
                
                // Save/Update User Profile
                update(userRef, {
                    name: user.displayName,
                    email: user.email,
                    photo: user.photoURL,
                    lastLogin: Date.now()
                });

                // Init UI
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                
                document.getElementById('user-avatar-top').src = user.photoURL;
                document.getElementById('profile-img').src = user.photoURL;
                document.getElementById('profile-name').innerText = user.displayName;
                document.getElementById('profile-email').innerText = user.email;

                // Check VIP
                if (userData && userData.isVIP) {
                    enableVIPMode();
                }

                teddy.speak(`Namaste ${user.displayName.split(' ')[0]}! Welcome back to ExploreMeet.`);
                loadFriends();

            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        function enableVIPMode() {
            document.getElementById('header-vip').style.display = 'inline-block';
            document.getElementById('ad-container').style.display = 'none';
            document.querySelector('.bottom-nav').style.bottom = '0';
            document.querySelectorAll('.content-section').forEach(s => s.style.height = 'calc(100vh - 80px)');
            document.getElementById('vip-status-display').innerHTML = '<span style="color:gold">ðŸŒŸ VIP Member</span>';
            document.getElementById('buy-vip-btn').style.display = 'none';
        }

        // --- VIP LOGIC ---
        document.getElementById('buy-vip-btn').addEventListener('click', () => {
            if(!currentUser) return;
            if(confirm("Confirm purchase of VIP Status?")) {
                update(ref(db, 'users/' + currentUser.uid), { isVIP: true });
                enableVIPMode();
                teddy.speak("Badhaai ho! Aap ab VIP member hain.");
            }
        });

        // --- MATCHING SYSTEM & VIDEO LOGIC ---
        const matchStatus = document.getElementById('match-status');
        
        document.getElementById('start-match-btn').addEventListener('click', startMatching);

        async function startMatching() {
            if (!currentUser) return;

            matchStatus.innerText = "Searching for partner...";
            teddy.speak("Wait karo, partner dhoond raha hoon.");

            // Basic Queue Logic: Add self to 'queue', listen for match
            const queueRef = ref(db, 'queue');
            
            // 1. Add self to queue
            const myEntry = { uid: currentUser.uid, timestamp: Date.now() };
            await set(ref(db, 'queue/' + currentUser.uid), myEntry);
            
            // Remove from queue on disconnect
            onDisconnect(ref(db, 'queue/' + currentUser.uid)).remove();

            // 2. Check for other users
            // In a real app, this needs backend transactions. 
            // Here we do a client-side "First Available" check.
            const queueSnap = await get(queueRef);
            let matchFound = false;
            
            if (queueSnap.exists()) {
                const users = queueSnap.val();
                const userKeys = Object.keys(users);
                
                for (let key of userKeys) {
                    if (key !== currentUser.uid) {
                        // Match Found!
                        matchFound = true;
                        currentMatchUid = key;
                        const partner = users[key];
                        
                        // Create Room ID (Unique string based on sorted UIDs to be consistent)
                        const ids = [currentUser.uid, currentMatchUid].sort();
                        currentRoomId = `room_${ids[0]}_${ids[1]}`;

                        // Signal match to both
                        // We simply remove both from queue and start video
                        // NOTE: In production, use a dedicated 'matches' node to handshake.
                        // Simplification for Single File: Join room derived from IDs immediately.
                        
                        await remove(ref(db, 'queue/' + currentUser.uid));
                        await remove(ref(db, 'queue/' + currentMatchUid)); // Optimistic remove
                        
                        initiateVideoCall(currentRoomId);
                        break;
                    }
                }
            }

            if (!matchFound) {
                // Wait in queue. 
                // Listen if someone else picks me up (removed from queue means matched in this simplified logic, 
                // but better to listen to a specific 'active_call' node).
                // fallback: simple timeout for demo or polling.
                matchStatus.innerText = "Waiting in queue...";
                
                // Watch for my removal from queue (implies someone matched me) 
                // OR checking if a room with my ID exists in a real signaling server.
                // For this Zego UIKit Prebuilt, we just need the same RoomID.
                // Hack for demo: Check queue periodically.
                
                let checkInterval = setInterval(async () => {
                    const stillInQueue = (await get(ref(db, 'queue/' + currentUser.uid))).exists();
                    if (!stillInQueue) {
                        // I was removed! Assuming match. 
                        // But I need the RoomID. 
                        // Simplified Strategy 2: Just generate a Random Room ID and force the other person to join? No.
                        // Revised Strategy for Serverless Demo:
                        // Just join a global "waiting" room? No.
                        // Let's use a Listener on a 'matches/{uid}' node.
                    }
                }, 2000);
                
                // Actually, let's implement the 'matches' node logic for robustness.
            }
        }
        
        // --- ROBUST MATCHING LISTENER ---
        // When clicking start, we actually listen to `matches/{myUid}`
        // If we find a partner, we write to `matches/{partnerUid}`
        
        async function robustStartMatching() {
            if (!currentUser) return;
            matchStatus.innerText = "Partner dhoond raha hoon...";
            
            const myMatchRef = ref(db, 'matches/' + currentUser.uid);
            onDisconnect(myMatchRef).remove();

            // Listen for a match
            onValue(myMatchRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.roomId) {
                    // I have been matched!
                    currentMatchUid = data.partnerUid;
                    currentRoomId = data.roomId;
                    // Remove myself from queue
                    remove(ref(db, 'queue/' + currentUser.uid));
                    // Start Call
                    initiateVideoCall(currentRoomId);
                    // Clear match ref after joining
                    remove(myMatchRef);
                }
            });

            // Add to Queue
            await set(ref(db, 'queue/' + currentUser.uid), {
                uid: currentUser.uid,
                name: currentUser.displayName
            });
            onDisconnect(ref(db, 'queue/' + currentUser.uid)).remove();

            // Try to act as the Matcher
            const queueSnap = await get(ref(db, 'queue'));
            if(queueSnap.exists()) {
                const users = queueSnap.val();
                const keys = Object.keys(users);
                
                for(let key of keys) {
                    if (key !== currentUser.uid) {
                        // Found someone waiting
                        const partnerUid = key;
                        const roomId = `meet_${Date.now()}`;
                        
                        // Notify Partner
                        await set(ref(db, 'matches/' + partnerUid), {
                            roomId: roomId,
                            partnerUid: currentUser.uid
                        });

                        // Notify Self (via local execution, or writing to DB to trigger own listener)
                        // Let's write to self to trigger own listener for consistency
                        await set(ref(db, 'matches/' + currentUser.uid), {
                            roomId: roomId,
                            partnerUid: partnerUid
                        });
                        
                        // Clean Queue
                        await remove(ref(db, 'queue/' + partnerUid));
                        await remove(ref(db, 'queue/' + currentUser.uid));
                        break;
                    }
                }
            }
        }

        // Override the click handler to use the robust version
        document.getElementById('start-match-btn').onclick = robustStartMatching;

        // --- ZEGO CLOUD INTEGRATION ---
        function initiateVideoCall(roomId) {
            matchStatus.innerText = "";
            teddy.speak("Call connect ho rahi hai, best of luck!");
            
            document.getElementById('video-layer').style.display = 'block';
            document.getElementById('friend-req-btn-video').style.display = 'block';

            // Generate Token
            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(
                ZEGO_APP_ID, 
                ZEGO_SERVER_SECRET, 
                roomId, 
                currentUser.uid, 
                currentUser.displayName
            );

            // Create Instance
            zegoInstance = ZegoUIKitPrebuilt.create(kitToken);

            zegoInstance.joinRoom({
                container: document.querySelector("#video-layer"),
                scenario: {
                    mode: ZegoUIKitPrebuilt.OneONOneCall, 
                },
                showPreJoinView: false,
                turnOnCameraWhenJoining: true,
                turnOnMicrophoneWhenJoining: true,
                showLeaveRoomConfirmDialog: false, // Immediate exit
                onLeaveRoom: () => {
                    handleCallEnd();
                }
            });
        }

        function handleCallEnd() {
            // DO NOT RELOAD
            if (zegoInstance) {
                zegoInstance.destroy();
                zegoInstance = null;
            }
            
            document.getElementById('video-layer').style.display = 'none';
            document.getElementById('friend-req-btn-video').style.display = 'none';
            document.getElementById('next-match-overlay').style.display = 'flex';
            
            teddy.speak("Call khatam. Chalo next partner dhoondte hain.");
        }

        window.findNextMatch = () => {
            document.getElementById('next-match-overlay').style.display = 'none';
            robustStartMatching();
        };

        window.closeVideoOverlay = () => {
            document.getElementById('next-match-overlay').style.display = 'none';
            // Return to home state
            matchStatus.innerText = "";
        };

        // --- FRIEND REQUEST LOGIC ---
        window.sendFriendRequest = async () => {
            if (!currentMatchUid) return;
            
            // Add to my friends
            await set(ref(db, `users/${currentUser.uid}/friends/${currentMatchUid}`), true);
            // Add to their friends (Mutual for demo simplicity)
            await set(ref(db, `users/${currentMatchUid}/friends/${currentUser.uid}`), true);

            teddy.speak("Badhaai ho! New friend ban gaya.");
            alert("Friend Added!");
            document.getElementById('friend-req-btn-video').style.display = 'none'; // Hide button after click
        };

        function loadFriends() {
            const friendsRef = ref(db, `users/${currentUser.uid}/friends`);
            onValue(friendsRef, async (snapshot) => {
                const list = document.getElementById('friends-list');
                list.innerHTML = "";
                
                if (snapshot.exists()) {
                    const friends = snapshot.val();
                    for (let uid of Object.keys(friends)) {
                        // Fetch friend details
                        const fSnap = await get(ref(db, `users/${uid}`));
                        const fData = fSnap.val();
                        
                        const div = document.createElement('div');
                        div.className = 'friend-item';
                        div.innerHTML = `
                            <img src="${fData.photo || 'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:50%;">
                            <div>
                                <div style="font-weight:bold">${fData.name}</div>
                                <div style="font-size:0.8rem; color:#ccc;">Connected</div>
                            </div>
                        `;
                        list.appendChild(div);
                    }
                } else {
                    list.innerHTML = "<p>No friends yet.</p>";
                }
            });
        }

    </script>
</body>
</html>