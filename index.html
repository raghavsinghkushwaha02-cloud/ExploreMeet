<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExploreMeet Chat</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --primary: #ff4b7d; /* Romantic Pink */
            --primary-dark: #d6336c;
            --bg: #121212;
            --surface: #1e1e2c;
            --text: #ffffff;
            --glass: rgba(30, 30, 44, 0.85);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); overflow: hidden; height: 100vh; width: 100vw; }

        /* --- Utility & Animations --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 125, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 75, 125, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 125, 0); } }

        /* --- Login Screen --- */
        #login-screen {
            height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #121212 0%, #2a0a14 100%);
            text-align: center; padding: 20px;
        }
        .logo-text { font-size: 2.5rem; font-weight: 600; background: linear-gradient(to right, #ff9a9e, #ff4b7d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .tagline { font-size: 1rem; opacity: 0.7; margin-bottom: 40px; }
        
        .btn-google {
            background: white; color: #333; padding: 12px 24px; border-radius: 50px; border: none; font-weight: 600;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 1rem;
        }

        /* --- Main App Area --- */
        #app-screen { position: relative; height: 100%; width: 100%; display: flex; flex-direction: column; }

        /* Top Bar */
        .top-bar {
            position: absolute; top: 0; width: 100%; padding: 15px; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .vip-badge {
            background: linear-gradient(45deg, #ffd700, #ffaa00); color: #000; padding: 4px 12px;
            border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 0 10px #ffd700;
        }

        /* Video Container */
        .video-container { flex: 1; position: relative; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Remote Video (Full Screen) */
        #remote-video { width: 100%; height: 100%; }
        
        /* Local Video (PiP) */
        #local-video {
            position: absolute; top: 70px; right: 15px; width: 100px; height: 140px;
            border-radius: 12px; border: 2px solid var(--primary); object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 5;
        }

        /* State Overlay (Searching/Waiting) */
        #status-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 4;
        }
        .loading-heart { font-size: 4rem; color: var(--primary); animation: beat 1s infinite; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* Controls Bottom */
        .controls-area {
            position: absolute; bottom: 0; width: 100%; padding: 15px 20px 30px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 10; display: flex; flex-direction: column; gap: 10px;
        }

        /* Chat Messages Area */
        #chat-messages {
            height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            mask-image: linear-gradient(to bottom, transparent, black 20%);
            margin-bottom: 10px;
        }
        .msg { padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; max-width: 80%; width: fit-content; }
        .msg.me { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.them { background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Action Buttons */
        .actions-row { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        
        .btn-circle {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: white; cursor: pointer; transition: transform 0.2s;
        }
        .btn-circle:active { transform: scale(0.9); }
        
        .btn-chat { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        .btn-skip { background: #333; color: #fff; }
        .btn-like { background: var(--primary); box-shadow: 0 0 15px rgba(255, 75, 125, 0.6); }

        /* Chat Input */
        #input-area { display: flex; gap: 10px; margin-top: 10px; }
        #msg-input {
            flex: 1; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 25px; padding: 10px 15px; color: white; outline: none;
        }

        /* Admin/Ad Banner Placeholder */
        #ad-banner {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); color: black; padding: 5px 15px;
            border-radius: 5px; font-size: 0.8rem; z-index: 8; display: none;
        }

        /* Floater Hearts */
        .floater { position: absolute; bottom: 100px; right: 20px; font-size: 2rem; animation: floatUp 2s ease-out forwards; z-index: 20; pointer-events: none;}
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(0.5); } 100% { opacity: 0; transform: translateY(-150px) scale(1.5); } }

    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="logo-text">ExploreMeet</div>
        <div class="tagline">Connect. Chat. Fall in Love.</div>
        <button class="btn-google pulse" onclick="loginWithGoogle()">
            <span class="material-icons-round">login</span> Login with Google
        </button>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="hidden">
        
        <!-- Top Bar -->
        <div class="top-bar">
            <div id="vip-status" class="hidden vip-badge">VIP MEMBER</div>
            <div style="flex:1"></div>
            <div class="btn-circle btn-chat" style="width:35px; height:35px;" onclick="logout()">
                <span class="material-icons-round" style="font-size:1.2rem">logout</span>
            </div>
        </div>

        <div id="ad-banner">‚ú® Upgrade to VIP to remove ads!</div>

        <!-- Video Area -->
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            
            <!-- Searching/Waiting Overlay -->
            <div id="status-overlay">
                <div class="loading-heart material-icons-round">favorite</div>
                <p id="status-text" style="margin-top:10px; font-weight:300;">Ready to explore?</p>
                <button onclick="startSearch()" style="margin-top:20px; background:white; color:var(--primary); border:none; padding:10px 30px; border-radius:25px; font-weight:bold;">START</button>
            </div>
        </div>

        <!-- Controls & Chat -->
        <div class="controls-area">
            <div id="chat-messages"></div>
            
            <div id="input-area" class="hidden">
                <input type="text" id="msg-input" placeholder="Type a romantic message..." onkeypress="handleEnter(event)">
                <button class="btn-circle btn-like" style="width:40px; height:40px" onclick="sendMessage()">
                    <span class="material-icons-round">send</span>
                </button>
            </div>

            <div class="actions-row">
                <button class="btn-circle btn-chat" onclick="toggleChatInput()">
                    <span class="material-icons-round">chat_bubble</span>
                </button>
                
                <button class="btn-circle btn-like pulse" onclick="sendHeart()">
                    <span class="material-icons-round">favorite</span>
                </button>

                <button class="btn-circle btn-skip" onclick="nextPerson()">
                    <span class="material-icons-round">skip_next</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Admin Email
        const ADMIN_EMAIL = "raghavsinghkushwaha02@gmail.com";

        // Global State
        let currentUser = null;
        let currentRoomId = null;
        let isVIP = false;
        let localStream = null;
        let peerConnection = null;
        let isSearching = false;

        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const statusOverlay = document.getElementById('status-overlay');
        const statusText = document.getElementById('status-text');
        const chatMsgs = document.getElementById('chat-messages');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Check Ban Status
                const banRef = db.ref('bans/' + user.uid);
                banRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        auth.signOut();
                        alert("üö´ You have been banned by the Admin.");
                        location.reload();
                    }
                });

                currentUser = user;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                
                // Check VIP & settings
                checkUserProfile();
                setupLocalCamera();
            } else {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
        });

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert(e.message));
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        function checkUserProfile() {
            // Check if VIP
            db.ref(`users/${currentUser.uid}`).on('value', sn => {
                const data = sn.val() || {};
                isVIP = data.isVIP || false;
                if(isVIP) document.getElementById('vip-status').classList.remove('hidden');
                
                // Ads Logic
                db.ref('settings/showAds').once('value', s => {
                    if(s.val() && !isVIP) {
                        document.getElementById('ad-banner').style.display = 'block';
                    } else {
                        document.getElementById('ad-banner').style.display = 'none';
                    }
                });
            });
            
            // Create user entry
            db.ref(`users/${currentUser.uid}`).update({
                name: currentUser.displayName,
                email: currentUser.email,
                photo: currentUser.photoURL,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // ==========================================
        // WEBRTC & MATCHING LOGIC
        // ==========================================
        async function setupLocalCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (e) {
                alert("Camera access denied. Please enable permissions.");
            }
        }

        async function startSearch() {
            if(!localStream) await setupLocalCamera();
            
            isSearching = true;
            statusOverlay.classList.remove('hidden'); // keep background but hide button
            statusOverlay.innerHTML = `<div class="loading-heart material-icons-round">favorite</div><p style="margin-top:10px">Finding a date...</p>`;
            chatMsgs.innerHTML = '';
            remoteVideo.srcObject = null;

            // Simple Queue Logic
            const queueRef = db.ref('queue');
            
            // Look for someone waiting
            const snapshot = await queueRef.orderByKey().limitToFirst(1).once('value');
            
            if (snapshot.exists()) {
                // Found someone!
                const otherUserKey = Object.keys(snapshot.val())[0];
                if(otherUserKey === currentUser.uid) return; // Don't match self

                // Remove them from queue so no one else grabs them
                await queueRef.child(otherUserKey).remove();

                // Create a room
                currentRoomId = [currentUser.uid, otherUserKey].sort().join('_');
                
                // Signal them to join
                db.ref(`users/${otherUserKey}/match`).set({
                    roomId: currentRoomId,
                    initiator: currentUser.uid
                });
                
                initializeCall(true); // I am the caller
            } else {
                // No one waiting, add myself
                const myRef = queueRef.child(currentUser.uid);
                myRef.set({ timestamp: firebase.database.ServerValue.TIMESTAMP });
                myRef.onDisconnect().remove();

                // Listen for a match assigned to me
                db.ref(`users/${currentUser.uid}/match`).on('value', (sn) => {
                    const matchData = sn.val();
                    if (matchData) {
                        currentRoomId = matchData.roomId;
                        myRef.remove(); // Remove from queue
                        db.ref(`users/${currentUser.uid}/match`).off(); // Stop listening
                        initializeCall(false); // I am the callee
                    }
                });
            }
        }

        function nextPerson() {
            if(peerConnection) peerConnection.close();
            if(currentRoomId) {
                db.ref(`rooms/${currentRoomId}`).remove();
                currentRoomId = null;
            }
            startSearch();
        }

        // ==========================================
        // WEBRTC CORE
        // ==========================================
        async function initializeCall(isCaller) {
            statusOverlay.classList.add('hidden'); // Show video
            peerConnection = new RTCPeerConnection(servers);

            // Add local tracks
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Handle remote stream
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };

            // ICE Candidates
            const roomRef = db.ref(`rooms/${currentRoomId}`);
            const myCandidates = roomRef.child(isCaller ? 'callerCandidates' : 'calleeCandidates');
            const theirCandidates = roomRef.child(isCaller ? 'calleeCandidates' : 'callerCandidates');

            peerConnection.onicecandidate = event => {
                if (event.candidate) myCandidates.push(event.candidate.toJSON());
            };

            // Signalling
            if (isCaller) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await roomRef.child('offer').set({
                    sdp: offer.sdp,
                    type: offer.type
                });
            }

            // Listen for signaling data
            roomRef.on('value', async snapshot => {
                const data = snapshot.val();
                if (!peerConnection || !data) return;

                if (!isCaller && data.offer && !peerConnection.currentRemoteDescription) {
                    const offer = new RTCSessionDescription(data.offer);
                    await peerConnection.setRemoteDescription(offer);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await roomRef.child('answer').set({
                        sdp: answer.sdp,
                        type: answer.type
                    });
                }

                if (isCaller && data.answer && !peerConnection.currentRemoteDescription) {
                    const answer = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(answer);
                }
            });

            // Listen for ICE candidates
            theirCandidates.on('child_added', snapshot => {
                const candidate = new RTCIceCandidate(snapshot.val());
                peerConnection.addIceCandidate(candidate);
            });

            // Listen for Chat
            roomRef.child('chat').on('child_added', sn => {
                const msg = sn.val();
                addMessageToUI(msg.text, msg.sender === currentUser.uid);
            });

            // Listen for End/Next
            roomRef.on('child_removed', () => {
                 // If the room is deleted or partner disconnects
                 // In a real app, show "Partner left" then restart
            });
        }

        // ==========================================
        // CHAT & INTERACTIONS
        // ==========================================
        function toggleChatInput() {
            document.getElementById('input-area').classList.toggle('hidden');
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendMessage();
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentRoomId) return;

            db.ref(`rooms/${currentRoomId}/chat`).push({
                sender: currentUser.uid,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            input.value = '';
        }

        function addMessageToUI(text, isMe) {
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'them'} fade-in`;
            div.innerText = text;
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        function sendHeart() {
            if(!currentRoomId) return;
            // Visual effect
            const heart = document.createElement('div');
            heart.innerHTML = '‚ù§Ô∏è';
            heart.className = 'floater';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 2000);

            // Send system message
            db.ref(`rooms/${currentRoomId}/chat`).push({
                sender: currentUser.uid,
                text: "‚ù§Ô∏è Sent a heart!",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
    </script>
</body>
</html>