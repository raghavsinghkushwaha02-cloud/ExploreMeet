<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>ExploreMeet | Video Chat</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>

    <style>
        :root {
            --primary: #ff0055;
            --bg: #0a0a12;
            --glass: rgba(255, 255, 255, 0.08);
            --nav-height: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 2000;
            background: var(--bg);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 30px; border-radius: 30px; font-weight: 700; font-size: 1rem;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.4); cursor: pointer;
        }

        /* --- Main App Area --- */
        #app-container {
            flex: 1;
            position: relative;
            overflow-y: auto;
            height: calc(100vh - var(--nav-height));
            padding-bottom: 20px;
        }

        /* --- TABS CONFIGURATION (CRITICAL FIX) --- */
        .tab-content {
            display: none !important; /* Strictly hidden by default */
            width: 100%;
            min-height: 100%;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        /* Only active tab is shown */
        .tab-content.active {
            display: flex !important;
            flex-direction: column;
            align-items: center;
        }

        /* Tab Specific Alignments */
        #home-tab.active { justify-content: center; text-align: center; }
        #messages-tab.active, #friends-tab.active, #profile-tab.active { justify-content: flex-start; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HOME TAB (Calling Option) --- */
        .avatar-ring {
            width: 140px; height: 140px; border-radius: 50%;
            border: 3px solid var(--primary); padding: 3px;
            position: relative; margin-bottom: 30px;
        }
        .avatar-ring img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .pulse-ring {
            position: absolute; inset: -10px; border: 2px solid var(--primary);
            border-radius: 50%; animation: pulse 2s infinite; opacity: 0;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }

        .big-start-btn {
            background: linear-gradient(45deg, #ff0055, #ff4081);
            width: 80%; padding: 18px; font-size: 1.2rem;
            text-transform: uppercase; letter-spacing: 1px;
            margin-top: 20px;
        }

        /* --- BOTTOM NAVIGATION (4 ICONS) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: #12121a;
            border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            padding-bottom: 5px; /* iOS safety */
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #666; font-size: 0.8rem; cursor: pointer;
            width: 25%;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { text-shadow: 0 0 10px var(--primary); }

        /* --- FRIENDS & MESSAGES LIST --- */
        .list-item {
            width: 100%; background: var(--glass);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; align-items: center; cursor: pointer;
        }
        .list-img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        
        /* --- PROFILE --- */
        .profile-card { text-align: center; width: 100%; margin-bottom: 20px; }
        .input-box { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; margin-bottom: 10px; border-radius: 8px; }

        /* --- VIDEO OVERLAY --- */
        #video-overlay {
            position: fixed; inset: 0; background: black; z-index: 3000;
            display: none;
        }
        #zego-mount { width: 100%; height: 100%; }
        
        .vid-controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center; gap: 20px; z-index: 3010;
        }
        .circle-btn {
            width: 55px; height: 55px; border-radius: 50%; border: none;
            color: white; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        }
        .stop { background: red; }
        .next { background: var(--primary); width: 120px; border-radius: 30px; font-weight: bold; }
        .add-friend { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); }

        /* --- SEARCHING LOADER --- */
        #searching-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 3005; display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* --- CHAT SCREEN --- */
        #chat-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 4000;
            display: none; flex-direction: column;
        }
        #chat-screen.open { display: flex; }
        .chat-head { height: 60px; background: #1a1a24; display: flex; align-items: center; padding: 0 15px; gap: 10px;}
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 10px; background: #1a1a24; display: flex; gap: 10px; }
        .msg { padding: 8px 14px; border-radius: 12px; max-width: 75%; font-size: 0.9rem; }
        .my-msg { background: var(--primary); align-self: flex-end; }
        .their-msg { background: #333; align-self: flex-start; }
    </style>
</head>
<body>

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen">
        <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 20px;">EXPLORE<span style="color:var(--primary)">MEET</span></h1>
        <button id="login-btn" class="btn"><i class="fab fa-google"></i> Login with Google</button>
    </div>

    <!-- 2. MAIN APP -->
    <div id="app-container" class="hidden">
        
        <!-- A. HOME TAB (Calling Option) -->
        <div id="home-tab" class="tab-content active">
            <h2 style="margin-bottom: 40px; letter-spacing: 2px;">RANDOM CHAT</h2>
            
            <div class="avatar-ring">
                <div class="pulse-ring"></div>
                <div class="pulse-ring" style="animation-delay: 1s;"></div>
                <img src="" id="home-avatar" referrerpolicy="no-referrer">
            </div>
            
            <h3 id="home-name" style="margin-bottom: 40px; color: #aaa;">Welcome User</h3>
            
            <!-- THE CALLING BUTTON -->
            <button id="start-btn" class="btn big-start-btn">
                START MATCHING <i class="fas fa-video" style="margin-left: 10px;"></i>
            </button>
        </div>

        <!-- B. MESSAGES TAB -->
        <div id="messages-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">Messages</h2>
            <div id="messages-list" style="width: 100%;">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- C. FRIENDS TAB -->
        <div id="friends-tab" class="tab-content">
            <h2 style="margin-bottom: 20px;">My Friends</h2>
            <div id="friends-list" style="width: 100%;">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- D. PROFILE TAB -->
        <div id="profile-tab" class="tab-content">
            <div class="profile-card">
                <img src="" id="profile-avatar" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary); margin-bottom:10px;" referrerpolicy="no-referrer">
                <h2 id="profile-name">User Name</h2>
                <div id="vip-badge" style="background:gold; color:black; display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold; display:none; margin-top:5px;">VIP</div>
            </div>
            
            <input type="text" value="Upload Photo logic here" class="input-box" readonly onclick="document.getElementById('file-up').click()">
            <input type="file" id="file-up" hidden>
            
            <button id="vip-btn" class="btn" style="width:100%; margin-bottom:15px; background: gold; color: black;">Upgrade to VIP (â‚¹199)</button>
            <button id="logout-btn" class="btn" style="width:100%; background: transparent; border: 1px solid red; color: red;">Logout</button>
        </div>

    </div>

    <!-- 3. BOTTOM NAVIGATION (4 ICONS) -->
    <nav class="bottom-nav hidden" id="nav-bar">
        <div class="nav-item active" data-target="home-tab">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" data-target="messages-tab">
            <i class="fas fa-comment-dots"></i>
            <span>Messages</span>
        </div>
        <div class="nav-item" data-target="friends-tab">
            <i class="fas fa-user-friends"></i>
            <span>Friends</span>
        </div>
        <div class="nav-item" data-target="profile-tab">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
    </nav>

    <!-- 4. VIDEO OVERLAY -->
    <div id="video-overlay">
        <div id="zego-mount"></div>
        
        <!-- Searching Spinner -->
        <div id="searching-overlay">
            <div class="avatar-ring">
                <div class="pulse-ring"></div>
                <img src="" id="search-avatar" referrerpolicy="no-referrer">
            </div>
            <h3>Finding Partner...</h3>
        </div>

        <button class="circle-btn add-friend" id="add-friend-btn"><i class="fas fa-user-plus"></i></button>

        <div class="vid-controls">
            <button class="circle-btn stop" id="stop-btn"><i class="fas fa-phone-slash"></i></button>
            <button class="circle-btn next" id="next-btn">NEXT <i class="fas fa-forward" style="margin-left:5px"></i></button>
        </div>
    </div>

    <!-- 5. CHAT OVERLAY -->
    <div id="chat-screen">
        <div class="chat-head">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size: 1.2rem; padding: 10px;"></i>
            <span id="chat-title" style="font-weight: bold; font-size: 1.1rem;">Chat</span>
        </div>
        <div class="chat-msgs" id="chat-body"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type..." style="flex:1; padding:10px; border-radius:20px; border:none; outline:none;">
            <button class="btn" onclick="sendMsg()" style="padding:10px 15px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        // --- CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, get, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const ZEGO_APP_ID = 2013687880;
        const ZEGO_SERVER_SECRET = "2576346c100ee42b720e88db26d01e53";

        let currentUser = null;
        let zp = null;
        let activeChatFriendId = null;
        let isSearching = false;
        let currentPartnerId = null;

        // --- AUTH LOGIC ---
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('nav-bar').classList.remove('hidden');
                
                // Set User Info
                const refUser = ref(db, `users/${user.uid}`);
                const snap = await get(refUser);
                const data = snap.val() || {};
                const pic = data.customPhoto || user.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';

                // Update All Avatars
                ['home-avatar', 'profile-avatar', 'search-avatar'].forEach(id => document.getElementById(id).src = pic);
                document.getElementById('home-name').innerText = user.displayName;
                document.getElementById('profile-name').innerText = user.displayName;

                if(data.subscription === 'VIP') document.getElementById('vip-badge').style.display = 'inline-block';

                update(refUser, { 
                    displayName: user.displayName, 
                    email: user.email, 
                    photoURL: user.photoURL 
                });

                loadFriends();
                
                // Force Go to Home Tab
                switchTab('home-tab');

            } else {
                currentUser = null;
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('nav-bar').classList.add('hidden');
            }
        });

        // --- NAVIGATION LOGIC ---
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.onclick = () => switchTab(item.dataset.target);
        });

        function switchTab(tabId) {
            // 1. Update Icons
            navItems.forEach(n => n.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-target="${tabId}"]`);
            if(activeNav) activeNav.classList.add('active');

            // 2. Hide All Contents
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            // 3. Show Target
            document.getElementById(tabId).classList.add('active');
        }

        // --- VIDEO MATCHING LOGIC ---
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('video-overlay').style.display = 'block';
            document.getElementById('searching-overlay').style.display = 'flex';
            document.getElementById('zego-mount').innerHTML = '';
            findMatch();
        };

        document.getElementById('stop-btn').onclick = () => {
            if(zp) zp.destroy();
            if(isSearching) remove(ref(db, `queue/${currentUser.uid}`));
            isSearching = false;
            document.getElementById('video-overlay').style.display = 'none';
        };

        document.getElementById('next-btn').onclick = () => {
            if(zp) zp.destroy();
            if(isSearching) remove(ref(db, `queue/${currentUser.uid}`));
            document.getElementById('zego-mount').innerHTML = '';
            document.getElementById('searching-overlay').style.display = 'flex';
            findMatch();
        };

        document.getElementById('add-friend-btn').onclick = () => {
             if(currentPartnerId) {
                update(ref(db, `users/${currentUser.uid}/friends/${currentPartnerId}`), { timestamp: Date.now() });
                alert("Friend Added!");
             } else {
                 alert("Wait for partner...");
             }
        };

        async function findMatch() {
            if(isSearching) return;
            isSearching = true;
            currentPartnerId = null;

            const qRef = ref(db, 'queue');
            const snap = await get(qRef);
            let found = false;

            if(snap.exists()) {
                snap.forEach(c => {
                    if(c.key !== currentUser.uid && !found) {
                        found = true;
                        currentPartnerId = c.key;
                        const roomId = c.val().roomId;
                        remove(ref(db, `queue/${c.key}`)); // Handshake
                        startZego(roomId);
                    }
                });
            }

            if(!found) {
                const myRoom = `room_${currentUser.uid}_${Date.now()}`;
                await set(ref(db, `queue/${currentUser.uid}`), { roomId: myRoom });
                
                onValue(ref(db, `queue/${currentUser.uid}`), (s) => {
                    if(isSearching && !s.exists()) {
                        // Someone picked us
                        startZego(myRoom);
                    }
                });
            }
        }

        function startZego(roomID) {
            isSearching = false;
            document.getElementById('searching-overlay').style.display = 'none';
            
            const token = ZegoUIKitPrebuilt.generateKitTokenForTest(
                ZEGO_APP_ID, ZEGO_SERVER_SECRET, roomID, currentUser.uid, currentUser.displayName || "User"
            );
            
            zp = ZegoUIKitPrebuilt.create(token);
            zp.joinRoom({
                container: document.getElementById('zego-mount'),
                scenario: { mode: ZegoUIKitPrebuilt.OneONOneCall },
                showPreJoinView: false,
                turnOnCameraWhenJoining: true,
                turnOnMicrophoneWhenJoining: true,
                showLeaveRoomConfirmDialog: false,
                showUserList: false,
                showRoomTimer: false
            });
        }

        // --- FRIENDS & MESSAGES ---
        function loadFriends() {
            const listRef = ref(db, `users/${currentUser.uid}/friends`);
            onValue(listRef, (snap) => {
                const mList = document.getElementById('messages-list');
                const fList = document.getElementById('friends-list');
                mList.innerHTML = ''; fList.innerHTML = '';

                if(snap.exists()) {
                    snap.forEach(c => {
                        const fid = c.key;
                        get(ref(db, `users/${fid}`)).then(uSnap => {
                            if(uSnap.exists()) {
                                const u = uSnap.val();
                                const html = `
                                    <div class="list-item" onclick="window.openChat('${fid}', '${u.displayName}')">
                                        <img src="${u.customPhoto || u.photoURL}" class="list-img">
                                        <div>
                                            <h4>${u.displayName}</h4>
                                            <p style="font-size:0.8rem; color:#aaa;">Tap to chat</p>
                                        </div>
                                    </div>
                                `;
                                mList.innerHTML += html;
                                fList.innerHTML += html;
                            }
                        });
                    });
                } else {
                    const empty = '<p style="text-align:center; padding:20px; color:#666">No friends yet.</p>';
                    mList.innerHTML = empty;
                    fList.innerHTML = empty;
                }
            });
        }

        // Expose to Window for HTML click
        window.openChat = (fid, name) => {
            activeChatFriendId = fid;
            document.getElementById('chat-title').innerText = name;
            document.getElementById('chat-screen').classList.add('open');
            loadChat();
        };

        window.closeChat = () => {
            document.getElementById('chat-screen').classList.remove('open');
            activeChatFriendId = null;
        };

        function loadChat() {
            const cid = currentUser.uid < activeChatFriendId ? `${currentUser.uid}_${activeChatFriendId}` : `${activeChatFriendId}_${currentUser.uid}`;
            onValue(ref(db, `messages/${cid}`), (s) => {
                const b = document.getElementById('chat-body');
                b.innerHTML = '';
                if(s.exists()) {
                    s.forEach(c => {
                        const m = c.val();
                        const d = document.createElement('div');
                        d.className = `msg ${m.sender === currentUser.uid ? 'my-msg' : 'their-msg'}`;
                        d.innerText = m.text;
                        b.appendChild(d);
                    });
                    b.scrollTop = b.scrollHeight;
                }
            });
        }

        window.sendMsg = () => {
            const i = document.getElementById('chat-input');
            const txt = i.value.trim();
            if(!txt || !activeChatFriendId) return;
            const cid = currentUser.uid < activeChatFriendId ? `${currentUser.uid}_${activeChatFriendId}` : `${activeChatFriendId}_${currentUser.uid}`;
            push(ref(db, `messages/${cid}`), { sender: currentUser.uid, text: txt, ts: serverTimestamp() });
            i.value = '';
        };
        
        // --- PROFILE UPLOAD ---
        document.getElementById('file-up').onchange = (e) => {
            const file = e.target.files[0];
            if(file) {
                const r = new FileReader();
                r.onload = () => {
                    update(ref(db, `users/${currentUser.uid}`), { customPhoto: r.result });
                    location.reload(); // Quick refresh to update all imgs
                };
                r.readAsDataURL(file);
            }
        };

    </script>
</body>
</html>