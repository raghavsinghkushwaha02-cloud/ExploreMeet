<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExploreMeet Pro - VIP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        /* --- CSS RESET & VARIABLES --- */
        :root { --primary: #4176FA; --gold: #FFD700; --danger: #ef4444; --bg: #F0F2F5; --text: #333; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg); overflow: hidden; }

        /* --- 1. LANDING PAGE --- */
        #landing-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; color: white; text-align: center;
        }
        .landing-content h1 { font-size: 3rem; margin-bottom: 10px; font-weight: 800; letter-spacing: 2px; }
        .google-login-btn {
            background: white; color: #333; border: none; padding: 15px 30px;
            font-size: 1.1rem; font-weight: bold; border-radius: 30px; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* --- 2. MAIN APP INTERFACE --- */
        #app-interface { display: none; height: 100%; flex-direction: column; }

        /* Header */
        .header {
            background: white; height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .vip-badge-header { display: none; background: var(--gold); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

        /* Screens */
        .screen-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .screen { display: none; flex-direction: column; align-items: center; animation: fadeIn 0.3s ease; }
        .active-screen { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ad Banner (Hidden for VIP) */
        .ad-banner {
            width: 100%; background: #ddd; padding: 10px; text-align: center; color: #555;
            margin-bottom: 15px; font-size: 0.9rem; border: 1px dashed #999;
        }

        /* Home Screen */
        .hero-card {
            width: 100%; max-width: 400px; border-radius: 20px; overflow: hidden; position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 30px;
        }
        .hero-img { width: 100%; display: block; }
        .hero-text { position: absolute; bottom: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); color: white; padding: 20px; text-align: center; }
        
        .join-btn {
            width: 100%; max-width: 300px; padding: 18px; border-radius: 15px; border: none;
            background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(65, 118, 250, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Profile Screen */
        .profile-card {
            background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 20px;
            text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); position: relative;
        }
        
        /* Profile Image Container - Clickable */
        .profile-img-container {
            position: relative; width: 110px; height: 110px; margin: 0 auto 15px auto; cursor: pointer;
        }
        .profile-pic { 
            width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--primary); 
            object-fit: cover; background: #eee; 
        }
        .camera-icon {
            position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: white;
            width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid white; font-size: 14px;
        }

        /* VIP STYLING */
        .is-vip .profile-pic { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        .vip-crown-icon { display: none; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: var(--gold); font-size: 24px; z-index: 10; }
        .is-vip .vip-crown-icon { display: block; }

        /* User Info Display */
        .user-email-display { font-size: 0.9rem; color: #777; margin-bottom: 20px; word-break: break-all; background: #f9f9f9; padding: 5px; border-radius: 5px; }

        .profile-inputs { width: 100%; margin-bottom: 20px; text-align: left; }
        .profile-inputs label { font-size: 0.8rem; color: #666; font-weight: 600; margin-left: 5px; }
        .profile-inputs input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        
        .premium-btn {
            width: 100%; padding: 12px; border-radius: 10px; background: linear-gradient(45deg, #FFD700, #FFA500);
            color: black; font-weight: bold; border: none; cursor: pointer; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px; animation: pulse 2s infinite;
        }
        .save-btn { width: 100%; padding: 12px; background: #333; color: white; border:none; border-radius: 10px; cursor: pointer; margin-bottom: 10px; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .logout-btn {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--danger);
            background: transparent; color: var(--danger); font-weight: bold; cursor: pointer;
        }

        /* Messages / Friends List */
        .friend-item {
            background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .friend-info { display: flex; align-items: center; gap: 10px; }
        .friend-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .chat-btn { background: var(--primary); color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; align-items: center; z-index: 90;
        }
        .nav-item { color: #aaa; font-size: 1.4rem; cursor: pointer; padding: 10px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }

        /* Overlays */
        #gender-screen, #matching-overlay, #video-container, #post-call-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000;
        }
        #gender-screen { background: white; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #video-container { background: #000; display: none; z-index: 9999; }
        
        #matching-overlay { background: rgba(255,255,255,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 4000; }
        .loader { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Post Call Logic */
        #post-call-modal {
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 10000;
        }
        .modal-box { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center; }
        .modal-btn { padding: 10px 20px; margin: 5px; border-radius: 5px; border: none; cursor: pointer; }
        .btn-yes { background: var(--primary); color: white; }
        .btn-no { background: #ddd; color: #333; }

        .gender-options { display: flex; gap: 20px; margin-top: 30px; }
        .gender-card {
            width: 140px; height: 180px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .male { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .female { background: linear-gradient(135deg, #ec4899, #db2777); }
        .gender-card i { font-size: 3rem; margin-bottom: 15px; }

    </style>
</head>
<body>

    <div id="landing-screen">
        <div class="landing-content">
            <h1>EXPLOREMEET</h1>
            <p>Connect. Chat. Go VIP.</p>
            <button class="google-login-btn" onclick="handleLogin()">
                <i class="fab fa-google"></i> Login with Google
            </button>
        </div>
    </div>

    <div id="app-interface">
        
        <div class="header">
            <div class="logo">ExploreMeet</div>
            <div id="vip-badge-display" class="vip-badge-header"><i class="fas fa-crown"></i> VIP</div>
        </div>

        <div class="screen-container">
            
            <div id="screen-home" class="screen active-screen">
                <div id="ad-banner" class="ad-banner">
                    <b>AD:</b> Download this cool game now! (Free users only)
                </div>

                <div class="hero-card">
                    <img src="https://images.unsplash.com/photo-1516321318423-f06f85e504b3?q=80&w=1000&auto=format&fit=crop" class="hero-img">
                    <div class="hero-text">
                        <h3>Start Matching</h3>
                        <p id="limit-text">Daily Limit: Checking...</p>
                    </div>
                </div>
                <button class="join-btn" onclick="openGenderScreen()">
                    <i class="fas fa-video"></i> Start Match
                </button>
            </div>

            <div id="screen-messages" class="screen">
                <h3 style="margin-bottom: 20px;">Your Friends</h3>
                <div id="friends-list" style="width: 100%;">
                    <div style="text-align: center; color: #888; margin-top: 30px;">
                        No friends yet. Match via video to add friends!
                    </div>
                </div>
            </div>

            <div id="screen-profile" class="screen">
                <div id="profile-card-container" class="profile-card">
                    <i class="fas fa-crown vip-crown-icon"></i>
                    
                    <div class="profile-img-container" onclick="document.getElementById('file-upload').click()">
                        <img id="user-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-pic">
                        <div class="camera-icon"><i class="fas fa-camera"></i></div>
                    </div>
                    <input type="file" id="file-upload" hidden accept="image/*" onchange="handleImageUpload(event)">
                    
                    <div id="display-email" class="user-email-display">loading email...</div>

                    <div class="profile-inputs">
                        <label>Display Name</label>
                        <input type="text" id="edit-name" placeholder="Enter Name">
                        
                        <label>Date of Birth</label>
                        <input type="date" id="edit-dob">
                        
                        <button class="save-btn" onclick="saveProfile()">Update Profile</button>
                    </div>

                    <button id="buy-premium-btn" class="premium-btn" onclick="buySubscription()">
                        <i class="fas fa-crown"></i> Go VIP (â‚¹99) - Remove Limits
                    </button>
                    
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="switchTab('messages')"><i class="fas fa-user-friends"></i></div>
            <div class="nav-item" onclick="switchTab('profile')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <div id="gender-screen">
        <h2>Who to match?</h2>
        <div class="gender-options">
            <div class="gender-card male" onclick="selectGender('male')">
                <i class="fas fa-mars"></i> Male
            </div>
            <div class="gender-card female" onclick="selectGender('female')">
                <i class="fas fa-venus"></i> Female
            </div>
        </div>
        <button onclick="closeGenderScreen()" style="margin-top: 20px; border:none; background:transparent;">Cancel</button>
    </div>

    <div id="matching-overlay"><div class="loader"></div><h3>Finding Partner...</h3></div>
    <div id="video-container"></div>
    
    <div id="post-call-modal">
        <div class="modal-box">
            <h3>Add Friend?</h3>
            <p>Send a friend request to stay connected.</p>
            <button class="modal-btn btn-yes" onclick="sendFriendRequest()">Yes, Add Friend</button>
            <button class="modal-btn btn-no" onclick="closePostCall()">No, Skip</button>
        </div>
    </div>

    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, remove, push, get, onDisconnect, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            storageBucket: "exploremeet---live.firebasestorage.app",
            messagingSenderId: "169038218786",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null;
        let userData = {};
        let currentMatchId = null;

        // --- AUTH & DATA LOADING ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
                document.getElementById('landing-screen').style.display = 'none';
                document.getElementById('app-interface').style.display = 'flex';
            } else {
                currentUser = null;
                document.getElementById('landing-screen').style.display = 'flex';
                document.getElementById('app-interface').style.display = 'none';
            }
        });

        function loadUserData(uid) {
            const userRef = ref(db, 'users/' + uid);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val() || {};
                userData = data;

                if (!data.registered) {
                    update(userRef, {
                        uid: uid,
                        name: currentUser.displayName,
                        email: currentUser.email,
                        // Default to standard avatar if Google photo fails
                        photo: currentUser.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png",
                        isVIP: false,
                        dailyCalls: 0,
                        lastReset: new Date().toDateString(),
                        registered: true
                    });
                }

                if (data.lastReset !== new Date().toDateString()) {
                    update(userRef, { dailyCalls: 0, lastReset: new Date().toDateString() });
                }

                updateUIForUser(data);
                loadFriendsList();
            });
        }

        function updateUIForUser(data) {
            document.getElementById('edit-name').value = data.name || currentUser.displayName;
            document.getElementById('edit-dob').value = data.dob || "";
            document.getElementById('display-email').innerText = data.email || currentUser.email; // SHOW EMAIL

            // Fix broken image by using a fallback
            const imgUrl = data.photo || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            document.getElementById('user-img').src = imgUrl;

            // VIP Logic
            const isVIP = data.isVIP === true;
            const profileCard = document.getElementById('profile-card-container');
            const vipBadgeHeader = document.getElementById('vip-badge-display');
            const adBanner = document.getElementById('ad-banner');
            const buyBtn = document.getElementById('buy-premium-btn');
            const limitText = document.getElementById('limit-text');

            if (isVIP) {
                profileCard.classList.add('is-vip');
                vipBadgeHeader.style.display = 'block';
                adBanner.style.display = 'none';
                buyBtn.innerHTML = '<i class="fas fa-check-circle"></i> VIP Member Active';
                buyBtn.disabled = true;
                buyBtn.style.background = "#4CAF50";
                limitText.innerText = "Unlimited Calls (VIP)";
            } else {
                profileCard.classList.remove('is-vip');
                vipBadgeHeader.style.display = 'none';
                adBanner.style.display = 'block';
                buyBtn.disabled = false;
                limitText.innerText = `Daily Calls: ${data.dailyCalls || 0} / 3`;
            }
        }

        // --- IMAGE UPLOAD LOGIC (COMPRESSION INCLUDED) ---
        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading state
            document.getElementById('user-img').style.opacity = '0.5';

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    // Create Canvas for compression
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to 200x200 max to save DB space
                    const maxWidth = 200;
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Convert to Base64 JPEG with low quality
                    const base64String = canvas.toDataURL('image/jpeg', 0.7);

                    // Update Firebase
                    update(ref(db, 'users/' + currentUser.uid), { photo: base64String })
                    .then(() => {
                        document.getElementById('user-img').src = base64String;
                        document.getElementById('user-img').style.opacity = '1';
                        alert("Profile picture updated!");
                    })
                    .catch(err => alert("Error uploading: " + err.message));
                }
            };
            reader.readAsDataURL(file);
        };

        // --- BUTTON HANDLERS ---
        window.handleLogin = async () => await signInWithPopup(auth, provider);
        window.handleLogout = () => signOut(auth);
        
        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + tab).classList.add('active-screen');
            const index = tab === 'home' ? 0 : tab === 'messages' ? 1 : 2;
            document.querySelectorAll('.nav-item')[index].classList.add('active');
        };

        window.saveProfile = () => {
            const newName = document.getElementById('edit-name').value;
            const newDob = document.getElementById('edit-dob').value;
            update(ref(db, 'users/' + currentUser.uid), { name: newName, dob: newDob });
            alert("Profile Updated!");
        };

        window.buySubscription = () => {
            var options = {
                "key": "rzp_live_SBirtJRkaeGMgl",
                "amount": "9900",
                "currency": "INR",
                "name": "ExploreMeet Premium",
                "description": "VIP Subscription",
                "image": "https://cdn-icons-png.flaticon.com/512/6941/6941697.png",
                "handler": function (response){
                    update(ref(db, 'users/' + currentUser.uid), { isVIP: true });
                    alert("Welcome to VIP! Ads removed & limits unlocked.");
                },
                "prefill": {
                    "name": currentUser.displayName,
                    "email": currentUser.email
                },
                "theme": { "color": "#4176FA" }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        };

        // --- VIDEO & LIMIT LOGIC ---
        window.openGenderScreen = () => {
            if (!userData.isVIP && (userData.dailyCalls >= 3)) {
                alert("Daily Limit Reached! Upgrade to VIP for unlimited calls.");
                window.switchTab('profile');
                return;
            }
            document.getElementById('gender-screen').style.display = 'flex';
        };

        window.closeGenderScreen = () => document.getElementById('gender-screen').style.display = 'none';

        window.selectGender = (gender) => {
            document.getElementById('gender-screen').style.display = 'none';
            document.getElementById('matching-overlay').style.display = 'flex';
            startMatchingLogic();
        };

        async function startMatchingLogic() {
            const queueRef = ref(db, 'queue');
            const snapshot = await get(queueRef);
            let matchFound = false;

            const newCount = (userData.dailyCalls || 0) + 1;
            update(ref(db, 'users/' + currentUser.uid), { dailyCalls: newCount });

            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    if (!matchFound && child.val().uid !== currentUser.uid && !child.val().matchedWith) {
                        matchFound = true;
                        const roomID = child.key;
                        const partnerUID = child.val().uid;
                        update(ref(db, `queue/${child.key}`), { matchedWith: currentUser.uid });
                        currentMatchId = partnerUID;
                        initVideoCall(roomID);
                    }
                });
            }

            if (!matchFound) {
                const myRef = push(queueRef);
                set(myRef, { uid: currentUser.uid, matchedWith: "" });
                
                onValue(myRef, (snap) => {
                    const val = snap.val();
                    if (val && val.matchedWith) {
                        currentMatchId = val.matchedWith;
                        initVideoCall(myRef.key);
                        setTimeout(() => remove(myRef), 5000);
                    }
                });
                onDisconnect(myRef).remove();
            }
        }

        function initVideoCall(roomID) {
            document.getElementById('matching-overlay').style.display = 'none';
            const videoContainer = document.getElementById('video-container');
            videoContainer.style.display = 'block';

            const appID = 2013687880; 
            const serverSecret = "2576346c100ee42b720e88db26d01e53";
            const userName = userData.name || currentUser.displayName;

            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(
                appID, serverSecret, roomID, currentUser.uid, userName
            );

            const zp = ZegoUIKitPrebuilt.create(kitToken);
            zp.joinRoom({
                container: videoContainer,
                scenario: { mode: ZegoUIKitPrebuilt.OneONoneCall },
                showPreJoinView: false,
                onLeaveRoom: () => {
                    videoContainer.style.display = 'none';
                    document.getElementById('post-call-modal').style.display = 'flex';
                }
            });
        }

        window.closePostCall = () => {
            document.getElementById('post-call-modal').style.display = 'none';
            location.reload();
        };

        window.sendFriendRequest = () => {
            if(currentMatchId) {
                update(ref(db, `users/${currentUser.uid}/friends/${currentMatchId}`), { status: 'friend' });
                update(ref(db, `users/${currentMatchId}/friends/${currentUser.uid}`), { status: 'friend' });
                alert("Friend Added!");
                closePostCall();
            } else {
                alert("Error finding match ID");
                closePostCall();
            }
        };

        function loadFriendsList() {
            const friendsRef = ref(db, `users/${currentUser.uid}/friends`);
            onValue(friendsRef, async (snapshot) => {
                const list = document.getElementById('friends-list');
                list.innerHTML = "";
                
                if(snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const friendId = childSnapshot.key;
                        get(ref(db, `users/${friendId}`)).then((friendSnap) => {
                            const fData = friendSnap.val();
                            if(fData) {
                                const html = `
                                    <div class="friend-item">
                                        <div class="friend-info">
                                            <img src="${fData.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="friend-img">
                                            <b>${fData.name}</b>
                                        </div>
                                        <button class="chat-btn" onclick="alert('Direct Chat coming soon!')">
                                            <i class="fas fa-comment"></i>
                                        </button>
                                    </div>
                                `;
                                list.innerHTML += html;
                            }
                        });
                    });
                } else {
                    list.innerHTML = `<div style="text-align: center; color: #888; margin-top: 30px;">No friends yet.</div>`;
                }
            });
        }
    </script>
</body>
</html>
