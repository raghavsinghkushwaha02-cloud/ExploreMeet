<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>ExploreMeet Live | Romantic Video Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #ff0099; --bg: #0f0c29; --card: #1a1a40; --text: #ffffff; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* Romantic Home UI */
        #home-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; text-align: center; }
        .avatar-container { position: relative; width: 150px; height: 150px; margin-bottom: 30px; }
        .avatar-container img { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--primary); object-fit: cover; }
        .pulse { position: absolute; inset: -10px; border: 2px solid var(--primary); border-radius: 50%; animation: pulse-out 2s infinite; }
        @keyframes pulse-out { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        .btn-neon { background: var(--primary); color: white; border: none; padding: 18px 60px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 20px var(--primary); transition: 0.3s; }
        
        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(26, 26, 64, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-item { color: #888; font-size: 1.5rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        /* Searching Screen */
        #searching-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #video-mount { position: fixed; inset: 0; z-index: 3000; background: #000; }
    </style>
</head>
<body>

    <div id="auth-screen" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="color:var(--primary); font-size:3rem;">ExploreMeet</h1>
        <button class="btn-neon" onclick="login()"><i class="fab fa-google"></i> Login to Dating</button>
    </div>

    <div id="main-app" class="hidden">
        <div id="home-screen">
            <div class="avatar-container">
                <div class="pulse"></div>
                <img id="user-photo" src="" referrerpolicy="no-referrer">
            </div>
            <h1>Find Your Match</h1>
            <p style="color:#aaa; margin-bottom:40px;">Ready for a romantic encounter?</p>
            <button class="btn-neon" onclick="startMatching()">START CHAT</button>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active"><i class="fas fa-heart"></i></div>
            <div class="nav-item"><i class="fas fa-comment"></i></div>
            <div class="nav-item" onclick="location.reload()"><i class="fas fa-user"></i></div>
        </nav>
    </div>

    <div id="searching-screen" class="hidden">
        <div class="avatar-container"><div class="pulse"></div><img id="search-photo" src=""></div>
        <h3>Searching for someone special...</h3>
        <button class="btn-neon" style="background:#444; box-shadow:none;" onclick="cancelSearch()">Cancel</button>
    </div>

    <div id="video-mount" class="hidden"></div>

    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const zpID = 2013687880, zpSecret = "2576346c100ee42b720e88db26d01e53";

        let currentUser = null, zp = null;

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const userRef = ref(db, `users/${user.uid}`);
                onValue(userRef, (snap) => {
                    const data = snap.val();
                    if (data && data.isBanned) {
                        alert("Your account is banned.");
                        signOut(auth).then(() => location.reload());
                        return;
                    }
                    if (!data) set(userRef, { name: user.displayName, email: user.email, photoURL: user.photoURL, vip: "Free", isBanned: false });
                    
                    document.getElementById('user-photo').src = user.photoURL;
                    document.getElementById('search-photo').src = user.photoURL;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                });
                
                // Monitor current room for incoming calls
                onValue(ref(db, `users/${user.uid}/currentRoom`), (snap) => {
                    if (snap.val()) startVideoCall(snap.val());
                });
            }
        });

        window.startMatching = async () => {
            document.getElementById('searching-screen').classList.remove('hidden');
            await set(ref(db, `waitingUsers/${currentUser.uid}`), { name: currentUser.displayName, ts: Date.now() });
            
            const waitRef = ref(db, 'waitingUsers');
            const snap = await get(waitRef);
            const pool = snap.val();
            const others = Object.keys(pool).filter(id => id !== currentUser.uid);

            if (others.length > 0) {
                const partnerId = others[0];
                const roomId = "room_" + Date.now();
                await set(ref(db, `rooms/${roomId}`), { u1: currentUser.uid, u2: partnerId });
                await update(ref(db, `users/${currentUser.uid}`), { currentRoom: roomId });
                await update(ref(db, `users/${partnerId}`), { currentRoom: roomId });
                remove(ref(db, `waitingUsers/${currentUser.uid}`));
                remove(ref(db, `waitingUsers/${partnerId}`));
            }
        };

        function startVideoCall(roomId) {
            document.getElementById('searching-screen').classList.add('hidden');
            document.getElementById('video-mount').classList.remove('hidden');
            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(zpID, zpSecret, roomId, currentUser.uid, currentUser.displayName);
            zp = ZegoUIKitPrebuilt.create(kitToken);
            zp.joinRoom({
                container: document.getElementById('video-mount'),
                scenario: { mode: ZegoUIKitPrebuilt.OneONoneCall },
                showPreJoinView: false,
                onLeaveRoom: () => endSession()
            });
        }

        function endSession() {
            if (zp) zp.destroy();
            update(ref(db, `users/${currentUser.uid}`), { currentRoom: null });
            document.getElementById('video-mount').classList.add('hidden');
        }

        window.cancelSearch = () => {
            remove(ref(db, `waitingUsers/${currentUser.uid}`));
            document.getElementById('searching-screen').classList.add('hidden');
        };
    </script>
</body>
</html>
