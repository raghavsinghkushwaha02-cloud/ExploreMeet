<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExploreMeet Premium</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* --- 1. PREMIUM THEME VARIABLES --- */
        :root {
            --bg: #0f0f1a;       /* Deep Dark Blue/Black */
            --card: rgba(255, 255, 255, 0.08); /* Glass Effect */
            --text: #ffffff;
            --primary: #ff0055;  /* Neon Pink (Romantic) */
            --accent: #00d2ff;   /* Cyber Blue */
            --gold: #ffd700;     /* VIP Gold */
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Montserrat', sans-serif; background-color: var(--bg); color: var(--text); overflow: hidden; }

        /* --- 2. ANIMATED BACKGROUND (Floating Hearts) --- */
        .hearts-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden; }
        .heart { position: absolute; color: var(--primary); opacity: 0.3; animation: floatUp 15s infinite linear; text-shadow: 0 0 10px var(--primary); }
        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0.5); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-10vh) scale(1.2); opacity: 0; } }

        /* --- 3. UTILITIES & COMPONENTS --- */
        .hidden { display: none !important; }
        .btn { border: none; outline: none; cursor: pointer; transition: 0.3s; font-family: inherit; }
        .glass-card { background: var(--card); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 4px 30px rgba(0,0,0,0.1); }
        
        /* --- 4. LANDING SCREEN (LOGIN) --- */
        #landing-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; background: var(--bg);
        }
        .app-logo { font-size: 3.5rem; font-weight: 800; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; letter-spacing: -2px; }
        .login-btn {
            background: white; color: #333; padding: 16px 40px; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            display: flex; align-items: center; gap: 10px; margin-top: 40px; box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
        }
        .login-btn:active { transform: scale(0.95); }

        /* --- 5. MAIN APP INTERFACE --- */
        #app-interface { display: none; height: 100%; flex-direction: column; }
        
        .header { height: 65px; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(15,15,26,0.8); backdrop-filter: blur(10px); }
        .vip-badge { background: linear-gradient(45deg, var(--gold), #ffaa00); color: black; padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: none; box-shadow: 0 0 10px var(--gold); }

        .screen-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; position: relative; }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .active-screen { display: flex; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HOME TAB */
        .radar-container { width: 260px; height: 260px; position: relative; display: flex; align-items: center; justify-content: center; margin-top: 40px; }
        .radar-circle { position: absolute; border: 1px solid var(--primary); width: 100%; height: 100%; border-radius: 50%; opacity: 0; animation: radarWave 3s infinite linear; }
        .radar-circle:nth-child(2) { animation-delay: 1s; }
        .radar-circle:nth-child(3) { animation-delay: 2s; }
        @keyframes radarWave { 0% { transform: scale(0.4); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }
        
        .my-avatar-lg { width: 90px; height: 90px; border-radius: 50%; border: 3px solid white; z-index: 2; object-fit: cover; box-shadow: 0 0 20px var(--primary); }
        
        .start-match-btn {
            background: linear-gradient(135deg, var(--primary), #ff4444); color: white; padding: 22px 70px;
            border-radius: 50px; font-size: 1.4rem; font-weight: 800; margin-top: 50px; border: 4px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 50px rgba(255, 0, 85, 0.5); animation: heartbeat 2s infinite;
        }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* PROFILE TAB */
        .profile-card { width: 100%; padding: 30px; text-align: center; margin-top: 10px; }
        .profile-img { width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 15px; object-fit: cover; }
        .input-box { width: 100%; margin-top: 15px; text-align: left; }
        .input-box label { font-size: 0.8rem; color: #888; margin-left: 10px; }
        .styled-input { width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 12px; color: white; margin-top: 5px; box-sizing: border-box; }
        
        .action-btn { width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; margin-top: 15px; font-size: 1rem; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-vip { background: var(--gold); color: #000; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* CHATS TAB */
        .friend-row { width: 100%; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        .initial-icon { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(45deg, #ff0055, #8e44ad); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(15,15,26,0.9); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); z-index: 100; }
        .nav-item { font-size: 1.6rem; color: #666; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); text-shadow: 0 0 15px var(--primary); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: var(--primary); border-radius: 50%; }

        /* ADS */
        #ad-container { position: fixed; bottom: 75px; width: 100%; min-height: 50px; background: #000; display: flex; align-items: center; justify-content: center; z-index: 99; }
        .ad-placeholder { color: #444; font-size: 0.7rem; letter-spacing: 1px; }

        /* --- 6. VIDEO CALL OVERLAY (Z-INDEX 5000) --- */
        #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; }
        #video-embed { width: 100%; height: 100%; }
        
        #in-call-controls { position: absolute; bottom: 100px; right: 20px; z-index: 5002; display: flex; flex-direction: column; gap: 20px; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-add-friend { background: white; color: var(--primary); }
        .btn-next-match { background: rgba(0,0,0,0.6); color: white; border: 2px solid white; backdrop-filter: blur(5px); }

        #next-match-overlay { position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(15,15,26,0.95); z-index: 5003; display: none; flex-direction: column; align-items: center; justify-content: center; }

    </style>
</head>
<body>

    <div class="hearts-bg" id="hearts-container"></div>

    <div id="landing-screen">
        <div class="app-logo">ExploreMeet</div>
        <p style="color:#aaa; letter-spacing: 2px; font-size: 0.9rem;">DATE. CHAT. CONNECT.</p>
        <button id="login-btn" class="login-btn">
            <i class="fab fa-google"></i> Login with Google
        </button>
        <div id="loading-spinner" class="hidden" style="margin-top: 20px; color: var(--primary);">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i>
        </div>
    </div>

    <div id="app-interface">
        <div class="header">
            <div style="font-weight: 800; font-size: 1.2rem;">EM<span style="color:var(--primary);">Live</span></div>
            <div id="vip-status" class="vip-badge"><i class="fas fa-crown"></i> VIP MEMBER</div>
        </div>

        <div class="screen-container">
            
            <div id="screen-home" class="screen active-screen">
                <div class="radar-container">
                    <div class="radar-circle"></div><div class="radar-circle"></div><div class="radar-circle"></div>
                    <img id="home-avatar" src="" class="my-avatar-lg">
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 5px;">Find Your Match</h2>
                <p style="color: #888; font-size: 0.9rem;">Random Video Chat</p>
                <button class="btn start-match-btn" onclick="startMatching()">
                    <i class="fas fa-video"></i> START
                </button>
            </div>

            <div id="screen-chats" class="screen">
                <h2 style="align-self: flex-start; margin-bottom: 20px;">Connections</h2>
                <div id="friends-list" style="width: 100%;">
                    </div>
            </div>

            <div id="screen-profile" class="screen">
                <div class="glass-card profile-card">
                    <img id="profile-img" src="" class="profile-img">
                    <h2 id="profile-name">User Name</h2>
                    <p id="profile-email" style="font-size: 0.8rem; color: #aaa;">user@email.com</p>

                    <div class="input-box">
                        <label>Your Bio</label>
                        <input type="text" id="inp-bio" class="styled-input" placeholder="I love music & travel...">
                    </div>
                    <div class="input-box">
                        <label>Date of Birth</label>
                        <input type="date" id="inp-dob" class="styled-input">
                    </div>

                    <button class="btn action-btn btn-save" onclick="saveProfile()">Save Profile</button>
                    
                    <button id="vip-buy-btn" class="btn action-btn btn-vip" onclick="buyVIP()">
                        <i class="fas fa-crown"></i> Upgrade to VIP (â‚¹199)
                    </button>

                    <button onclick="handleLogout()" style="margin-top: 30px; background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 10px 30px; border-radius: 30px; cursor: pointer;">Logout</button>
                </div>
            </div>

        </div>

        <div id="ad-container">
            <span class="ad-placeholder">[ AdMob Banner will load here ]</span>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-fire"></i></div>
            <div class="nav-item" onclick="switchTab('chats')"><i class="fas fa-heart"></i></div>
            <div class="nav-item" onclick="switchTab('profile')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <div id="video-layer">
        <div id="video-embed"></div>
        
        <div id="in-call-controls">
            <button class="btn round-btn btn-add-friend" onclick="addFriend()"><i class="fas fa-heart"></i></button>
            <button class="btn round-btn btn-next-match" onclick="nextMatch()"><i class="fas fa-forward"></i></button>
        </div>

        <div id="next-match-overlay">
            <h1 style="color: white; margin-bottom: 10px;">Call Ended</h1>
            <p style="color: #aaa; margin-bottom: 40px;">What's next?</p>
            
            <button class="btn start-match-btn" onclick="retryMatch()" style="margin-top: 0; padding: 18px 50px; font-size: 1.2rem;">
                FIND NEXT
            </button>
            
            <button onclick="exitVideoMode()" style="margin-top: 30px; background: transparent; color: #888; border: none; text-decoration: underline; cursor: pointer;">
                Back to Home
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, push, get, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            storageBucket: "exploremeet---live.firebasestorage.app",
            messagingSenderId: "169038218786",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // GLOBAL VARS
        let currentUser = null;
        let zegoInstance = null;
        let currentPartnerUID = null;

        // --- BACKGROUND ANIMATION ---
        const heartsContainer = document.getElementById('hearts-container');
        for(let i=0; i<20; i++){
            let h = document.createElement('div');
            h.className = 'heart'; h.innerHTML = '<i class="fas fa-heart"></i>';
            h.style.left = Math.random() * 100 + 'vw';
            h.style.animationDuration = (Math.random() * 10 + 10) + 's';
            h.style.fontSize = (Math.random() * 20 + 10) + 'px';
            heartsContainer.appendChild(h);
        }

        // --- AUTH & SECURITY ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('loading-spinner').classList.remove('hidden');
            try {
                await signInWithPopup(auth, new GoogleAuthProvider());
            } catch(e) {
                alert("Login Failed: " + e.message);
                document.getElementById('login-btn').style.display = 'flex';
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        });

        window.handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // SECURITY: CHECK BAN
                const banRef = ref(db, `users/${user.uid}/isBanned`);
                const banSnap = await get(banRef);
                if(banSnap.exists() && banSnap.val() === true) {
                    alert("ðŸš« Your account has been BANNED by Admin.");
                    signOut(auth);
                    return;
                }

                currentUser = user;
                
                // SAVE USER DATA FOR ADMIN
                update(ref(db, `users/${user.uid}`), {
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastSeen: Date.now()
                });

                // UI UPDATE
                document.getElementById('landing-screen').classList.add('hidden');
                document.getElementById('app-interface').style.display = 'flex';
                document.getElementById('home-avatar').src = user.photoURL;
                document.getElementById('profile-img').src = user.photoURL;
                document.getElementById('profile-name').innerText = user.displayName;
                document.getElementById('profile-email').innerText = user.email;

                // LOAD PROFILE DATA
                const userRef = ref(db, `users/${user.uid}`);
                get(userRef).then((snap) => {
                    const data = snap.val();
                    if(data.bio) document.getElementById('inp-bio').value = data.bio;
                    if(data.dob) document.getElementById('inp-dob').value = data.dob;
                    if(data.isVIP) activateVIP();
                });

                // LOAD NOTIFICATIONS
                loadNotifications();
                // LOAD ADS (If not VIP)
                loadAdSettings();
                // LOAD FRIENDS
                loadFriends();

            } else {
                currentUser = null;
                document.getElementById('landing-screen').classList.remove('hidden');
                document.getElementById('app-interface').style.display = 'none';
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('login-btn').style.display = 'flex';
            }
        });

        // --- MATCHING SYSTEM ---
        window.startMatching = () => {
            document.getElementById('video-layer').style.display = 'block';
            document.getElementById('video-embed').innerHTML = '<div style="color:white;text-align:center;padding-top:60%;"><h3><i class="fas fa-search fa-spin"></i> Searching...</h3></div>';
            document.getElementById('next-match-overlay').style.display = 'none';
            document.getElementById('in-call-controls').style.display = 'none';

            findMatch();
        };

        async function findMatch() {
            const queueRef = ref(db, 'queue');
            const snapshot = await get(queueRef);
            let matchFound = false;

            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    if (!matchFound && child.val().uid !== currentUser.uid && !child.val().matchedWith) {
                        matchFound = true;
                        currentPartnerUID = child.val().uid;
                        const roomID = child.key;
                        set(ref(db, `queue/${child.key}/matchedWith`), currentUser.uid);
                        initZego(roomID);
                    }
                });
            }

            if (!matchFound) {
                const myRef = push(queueRef);
                set(myRef, { uid: currentUser.uid, matchedWith: "" });
                onValue(myRef, (snap) => {
                    if (snap.val()?.matchedWith) {
                        currentPartnerUID = snap.val().matchedWith;
                        initZego(myRef.key);
                        setTimeout(() => remove(myRef), 5000);
                    }
                });
                onDisconnect(myRef).remove();
            }
        }

        // --- ZEGO VIDEO (NO RELOAD) ---
        function initZego(roomID) {
            document.getElementById('video-embed').innerHTML = ""; // Clear loader
            const appID = 2013687880; 
            const serverSecret = "2576346c100ee42b720e88db26d01e53";
            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, currentUser.uid, currentUser.displayName);
            
            zegoInstance = ZegoUIKitPrebuilt.create(kitToken);
            zegoInstance.joinRoom({
                container: document.getElementById('video-embed'),
                scenario: { mode: ZegoUIKitPrebuilt.OneONoneCall },
                showPreJoinView: false,
                turnOnCameraWhenJoining: true,
                showLeavingView: false, // Critical for custom exit
                onJoinRoom: () => {
                    document.getElementById('in-call-controls').style.display = 'flex';
                },
                onLeaveRoom: () => {
                    // Custom Exit Logic - Show Overlay
                    if(zegoInstance) zegoInstance.destroy();
                    document.getElementById('in-call-controls').style.display = 'none';
                    document.getElementById('video-embed').innerHTML = "";
                    document.getElementById('next-match-overlay').style.display = 'flex';
                }
            });
        }

        window.nextMatch = () => {
            if(zegoInstance) zegoInstance.destroy(); // Triggers onLeaveRoom
            // Force immediate retry
            setTimeout(() => {
                document.getElementById('next-match-overlay').style.display = 'none';
                window.startMatching();
            }, 500);
        };

        window.retryMatch = () => window.startMatching();
        
        window.exitVideoMode = () => {
            document.getElementById('video-layer').style.display = 'none';
        };

        window.addFriend = () => {
            if(currentPartnerUID) {
                update(ref(db), { [`users/${currentUser.uid}/friends/${currentPartnerUID}`]: true });
                alert("â¤ï¸ Friend Added!");
            }
        };

        // --- PAYMENT (RAZORPAY) ---
        window.buyVIP = () => {
            var options = {
                "key": "rzp_live_SBirtJRkaeGMgl", // LIVE KEY
                "amount": "19900", // 199 INR
                "currency": "INR",
                "name": "ExploreMeet VIP",
                "description": "Unlock Premium Features",
                "handler": function (response){
                    update(ref(db, `users/${currentUser.uid}`), { isVIP: true });
                    activateVIP();
                    alert("Payment Successful! You are now VIP.");
                },
                "theme": { "color": "#ff0055" }
            };
            var rzp = new Razorpay(options);
            rzp.open();
        };

        function activateVIP() {
            document.getElementById('vip-status').style.display = 'block';
            document.getElementById('vip-buy-btn').innerHTML = "<i class='fas fa-check'></i> VIP ACTIVE";
            document.getElementById('vip-buy-btn').disabled = true;
            document.getElementById('ad-container').style.display = 'none'; // Hide Ads
        }

        // --- ADMIN ADS & SETTINGS ---
        function loadAdSettings() {
            const adRef = ref(db, 'settings/ads');
            onValue(adRef, (snap) => {
                const settings = snap.val();
                if(settings && settings.status === 'on' && !document.getElementById('vip-status').style.display.includes('block')) {
                    // If Ads are ON and User is NOT VIP
                    document.getElementById('ad-container').style.display = 'flex';
                    // In a real APK, the AdMob SDK intercepts this div. 
                    // For now, we show a placeholder text.
                    document.querySelector('.ad-placeholder').innerText = "Banner ID: " + settings.banner;
                } else {
                    document.getElementById('ad-container').style.display = 'none';
                }
            });
        }

        function loadNotifications() {
            const notifRef = ref(db, `users/${currentUser.uid}/notifications`);
            onValue(notifRef, (snap) => {
                if(snap.exists()) {
                    // If new message from Admin exists, show alert
                    const msgs = snap.val();
                    const lastKey = Object.keys(msgs).pop();
                    alert("Message from Admin: " + msgs[lastKey].text);
                    remove(ref(db, `users/${currentUser.uid}/notifications`)); // Clear after reading
                }
            });
        }

        // --- PROFILE & FRIENDS ---
        window.saveProfile = () => {
            const bio = document.getElementById('inp-bio').value;
            const dob = document.getElementById('inp-dob').value;
            update(ref(db, `users/${currentUser.uid}`), { bio: bio, dob: dob });
            alert("Profile Updated!");
        };

        function loadFriends() {
            onValue(ref(db, `users/${currentUser.uid}/friends`), (snap) => {
                const list = document.getElementById('friends-list');
                list.innerHTML = "";
                if(snap.exists()) {
                    snap.forEach(child => {
                        list.innerHTML += `
                        <div class="glass-card friend-row">
                            <div class="initial-icon"><i class="fas fa-user"></i></div>
                            <div>
                                <h4 style="margin:0;">Connection</h4>
                                <small style="color:#aaa;">ID: ${child.key.substring(0,6)}...</small>
                            </div>
                            <button class="btn" style="margin-left:auto; background:var(--primary); color:white; padding:5px 15px; border-radius:20px;">Chat</button>
                        </div>`;
                    });
                } else {
                    list.innerHTML = "<p style='text-align:center; color:#666;'>No matches yet.</p>";
                }
            });
        }

        // --- TABS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('screen-' + tab).classList.add('active-screen');
            
            let idx = 0;
            if(tab === 'chats') idx = 1;
            if(tab === 'profile') idx = 2;
            document.querySelectorAll('.nav-item')[idx].classList.add('active');
        };
    </script>
</body>
</html>
