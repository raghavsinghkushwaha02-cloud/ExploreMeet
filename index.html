<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>ExploreMeet | Premium Video Chat</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>

    <style>
        :root {
            --primary: #ff0055;
            --primary-grad: linear-gradient(135deg, #ff0055, #ff4081);
            --bg: #050505;
            --card-bg: #121212;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --nav-height: 75px;
            --text-main: #ffffff;
            --text-sec: #888888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* Mobile Container Wrapper */
        .mobile-wrapper {
            width: 100%;
            max-width: 480px; /* Limits width on desktop */
            height: 100%;
            position: relative;
            background: var(--card-bg);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        /* --- UI COMPONENTS --- */
        
        /* Buttons */
        .btn {
            background: var(--primary-grad);
            color: white; border: none;
            padding: 15px 30px; border-radius: 50px;
            font-weight: 700; font-size: 1rem;
            box-shadow: 0 10px 25px rgba(255, 0, 85, 0.3);
            cursor: pointer; transition: transform 0.2s;
            width: 100%;
        }
        .btn:active { transform: scale(0.96); }
        .btn-outline { background: transparent; border: 2px solid #333; box-shadow: none; color: #888; }
        .btn-gold { background: linear-gradient(45deg, #FFD700, #FFA500); color: black; box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3); }

        /* Toast Notification */
        #toast {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95); padding: 12px 25px; border-radius: 30px;
            z-index: 5000; font-size: 0.9rem; border: 1px solid var(--glass-border);
            display: none; animation: slideDown 0.3s; pointer-events: none; white-space: nowrap;
        }
        @keyframes slideDown { from { top: -50px; opacity: 0; } to { top: 20px; opacity: 1; } }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: absolute; inset: 0; z-index: 2000;
            background: radial-gradient(circle at top right, #1a0b14, #000);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 30px;
            text-align: center;
        }
        .logo-glow {
            font-size: 3rem; font-weight: 800; margin-bottom: 10px;
            background: -webkit-linear-gradient(45deg, #fff, #ff0055);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255,0,85,0.4));
        }

        /* --- TABS & CONTENT --- */
        #app-content {
            flex: 1; overflow-y: auto; padding-bottom: calc(var(--nav-height) + 20px);
            position: relative;
        }
        
        .tab-content { display: none; padding: 25px; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: flex; flex-direction: column; align-items: center; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Home Tab */
        .home-container {
            height: 70vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; width: 100%;
        }
        .avatar-ring {
            width: 160px; height: 160px; border-radius: 50%;
            padding: 5px; position: relative; margin-bottom: 30px;
            background: linear-gradient(to bottom, var(--primary), #000);
        }
        .avatar-ring img { 
            width: 100%; height: 100%; border-radius: 50%; 
            object-fit: cover; border: 4px solid #000; 
        }
        .pulse-ring {
            position: absolute; inset: -10px; border: 2px solid var(--primary);
            border-radius: 50%; animation: pulse 2s infinite; opacity: 0;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.6); opacity: 0; } }

        /* Lists (Friends/Messages) */
        .list-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .list-item {
            width: 100%; background: var(--glass);
            backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 16px; display: flex; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.1); }
        .list-img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .status-dot { width: 10px; height: 10px; background: #00ff88; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid #000; }

        /* Profile */
        .profile-header { text-align: center; margin-bottom: 30px; width: 100%; }
        .stats-row { display: flex; justify-content: space-around; width: 100%; margin: 20px 0; }
        .stat-box { text-align: center; }
        .stat-num { font-size: 1.2rem; font-weight: bold; color: white; }
        .stat-label { font-size: 0.8rem; color: #666; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            height: 70px; background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(20px); border-radius: 25px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; border: 1px solid var(--glass-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nav-item {
            color: #666; font-size: 1.2rem; cursor: pointer;
            position: relative; transition: 0.3s;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .nav-item.active { color: white; background: var(--primary); transform: translateY(-10px); box-shadow: 0 5px 15px rgba(255,0,85,0.4); }

        /* --- VIDEO OVERLAY --- */
        #video-overlay {
            position: absolute; inset: 0; background: #000; z-index: 3000; display: none;
        }
        #zego-mount { width: 100%; height: 100%; }
        .vid-controls {
            position: absolute; bottom: 40px; width: 100%;
            display: flex; justify-content: center; gap: 25px; z-index: 3010;
        }
        .circle-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            color: white; font-size: 1.4rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .circle-btn:active { transform: scale(0.9); }
        .btn-stop { background: #ff3b30; box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4); }
        .btn-next { background: #00ff88; color: black; box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4); }
        .btn-friend { position: absolute; top: 30px; right: 20px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); width: 45px; height: 45px; font-size: 1rem;}

        /* --- CHAT SCREEN --- */
        #chat-screen {
            position: absolute; inset: 0; background: var(--card-bg); z-index: 4000;
            display: none; flex-direction: column;
        }
        #chat-screen.open { display: flex; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .chat-header {
            padding: 20px; background: rgba(30,30,30,0.9);
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid #333;
        }
        .chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #0a0a0a; }
        .msg { padding: 10px 16px; border-radius: 20px; max-width: 80%; font-size: 0.95rem; line-height: 1.4; }
        .my-msg { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .their-msg { background: #222; color: #ddd; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-footer { padding: 15px; background: #1a1a1a; display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #333; border: none; padding: 12px 20px; border-radius: 30px; color: white; outline: none; }

        /* Searching Animation */
        #searching-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 3005; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .radar {
            width: 80px; height: 80px; background: var(--primary);
            border-radius: 50%; position: relative;
            animation: radar 1s infinite alternate; margin-bottom: 20px;
        }
        @keyframes radar { from { box-shadow: 0 0 0 0 rgba(255,0,85,0.4); } to { box-shadow: 0 0 0 50px rgba(255,0,85,0); } }

    </style>
</head>
<body>

    <div class="mobile-wrapper">
        
        <!-- Toast Notification -->
        <div id="toast"><i class="fas fa-info-circle"></i> <span>Message here</span></div>

        <!-- 1. AUTH SCREEN -->
        <div id="auth-screen">
            <h1 class="logo-glow">EXPLORE</h1>
            <h2 style="color:white; margin-bottom: 40px; font-weight: 300;">Video Chat</h2>
            <button id="login-btn" class="btn">
                <i class="fab fa-google" style="margin-right: 10px;"></i> Continue with Google
            </button>
            <p style="margin-top: 20px; color: #666; font-size: 0.8rem;">By continuing, you agree to our Terms.</p>
        </div>

        <!-- 2. MAIN APP CONTENT -->
        <div id="app-content" class="hidden">
            
            <!-- A. HOME TAB -->
            <div id="home-tab" class="tab-content active">
                <div class="home-container">
                    <div class="avatar-ring">
                        <div class="pulse-ring"></div>
                        <div class="pulse-ring" style="animation-delay: 1s;"></div>
                        <img src="" id="home-avatar" referrerpolicy="no-referrer">
                    </div>
                    
                    <h2 id="home-name" style="margin-bottom: 5px;">User</h2>
                    <p style="color: var(--text-sec); margin-bottom: 40px;">Ready to meet someone new?</p>
                    
                    <button id="start-btn" class="btn" style="width: 80%; height: 60px; font-size: 1.1rem;">
                        <i class="fas fa-bolt" style="margin-right: 10px;"></i> START MATCHING
                    </button>
                </div>
            </div>

            <!-- B. MESSAGES TAB -->
            <div id="messages-tab" class="tab-content">
                <h2 style="margin-bottom: 20px; align-self: flex-start;">Messages</h2>
                <div id="messages-list" class="list-container">
                    <!-- Dynamic -->
                </div>
            </div>

            <!-- C. FRIENDS TAB -->
            <div id="friends-tab" class="tab-content">
                <h2 style="margin-bottom: 20px; align-self: flex-start;">Friends</h2>
                <div id="friends-list" class="list-container">
                    <!-- Dynamic -->
                </div>
            </div>

            <!-- D. PROFILE TAB -->
            <div id="profile-tab" class="tab-content">
                <div class="profile-header">
                    <div style="position: relative; display: inline-block;">
                        <img src="" id="profile-avatar" style="width:110px; height:110px; border-radius:50%; border:3px solid var(--primary); object-fit: cover;">
                        <div onclick="document.getElementById('file-up').click()" style="position: absolute; bottom: 0; right: 0; background: white; color: black; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;"><i class="fas fa-camera" style="font-size: 0.8rem;"></i></div>
                    </div>
                    <h2 id="profile-name" style="margin-top: 15px;">User Name</h2>
                    <div id="vip-badge" style="background: linear-gradient(45deg, gold, orange); color: black; display: none; padding: 4px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; margin-top: 8px; display: inline-block;">VIP MEMBER</div>
                </div>

                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-num" id="friend-count">0</div>
                        <div class="stat-label">Friends</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-num">0</div>
                        <div class="stat-label">Likes</div>
                    </div>
                </div>

                <div style="width: 100%; display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                    <button id="vip-btn" class="btn btn-gold">
                        <i class="fas fa-crown" style="margin-right: 8px;"></i> Get VIP Plan
                    </button>
                    <button id="logout-btn" class="btn btn-outline" style="border-color: #ff3b30; color: #ff3b30;">
                        Log Out
                    </button>
                </div>
                
                <input type="file" id="file-up" hidden>
            </div>

        </div>

        <!-- 3. BOTTOM NAVIGATION -->
        <nav class="bottom-nav hidden" id="nav-bar">
            <div class="nav-item active" data-target="home-tab"><i class="fas fa-fire"></i></div>
            <div class="nav-item" data-target="messages-tab"><i class="fas fa-comment-alt"></i></div>
            <div class="nav-item" data-target="friends-tab"><i class="fas fa-user-friends"></i></div>
            <div class="nav-item" data-target="profile-tab"><i class="fas fa-user"></i></div>
        </nav>

        <!-- 4. VIDEO OVERLAY -->
        <div id="video-overlay">
            <div id="zego-mount"></div>
            
            <!-- Searching -->
            <div id="searching-overlay">
                <div class="radar"></div>
                <img src="" id="search-avatar" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 20px; border: 2px solid white;">
                <h3>Finding Partner...</h3>
                <p style="color: #aaa; font-size: 0.9rem;">Please wait</p>
                <button onclick="document.getElementById('stop-btn').click()" style="margin-top: 30px; background: transparent; border: 1px solid white; color: white; padding: 8px 20px; border-radius: 20px;">Cancel</button>
            </div>

            <button class="circle-btn btn-friend" id="add-friend-btn"><i class="fas fa-plus"></i></button>

            <div class="vid-controls">
                <button class="circle-btn btn-stop" id="stop-btn"><i class="fas fa-phone-slash"></i></button>
                <button class="circle-btn btn-next" id="next-btn"><i class="fas fa-forward"></i></button>
            </div>
        </div>

        <!-- 5. CHAT OVERLAY -->
        <div id="chat-screen">
            <div class="chat-header">
                <i class="fas fa-chevron-left" onclick="closeChat()" style="font-size: 1.2rem; cursor: pointer;"></i>
                <div style="flex: 1;">
                    <h3 id="chat-title" style="font-size: 1.1rem;">Chat</h3>
                    <span style="font-size: 0.75rem; color: #00ff88;">Online</span>
                </div>
            </div>
            <div class="chat-body" id="chat-body"></div>
            <div class="chat-footer">
                <input type="text" id="chat-input" class="chat-input" placeholder="Type a message...">
                <button onclick="sendMsg()" style="width: 45px; height: 45px; border-radius: 50%; background: var(--primary); border: none; color: white;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, get, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const ZEGO_APP_ID = 2013687880;
        const ZEGO_SERVER_SECRET = "2576346c100ee42b720e88db26d01e53";

        let currentUser = null;
        let zp = null;
        let activeChatFriendId = null;
        let isSearching = false;
        let currentPartnerId = null;

        // --- UTILS ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.querySelector('span').innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- AUTH ---
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('nav-bar').classList.remove('hidden');
                
                const refUser = ref(db, `users/${user.uid}`);
                const snap = await get(refUser);
                const data = snap.val() || {};
                const pic = data.customPhoto || user.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';

                ['home-avatar', 'profile-avatar', 'search-avatar'].forEach(id => document.getElementById(id).src = pic);
                document.getElementById('home-name').innerText = user.displayName;
                document.getElementById('profile-name').innerText = user.displayName;

                if(data.subscription === 'VIP') document.getElementById('vip-badge').style.display = 'inline-block';

                update(refUser, { displayName: user.displayName, email: user.email, photoURL: user.photoURL });
                loadFriends();
                switchTab('home-tab');

            } else {
                currentUser = null;
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('nav-bar').classList.add('hidden');
            }
        });

        // --- NAVIGATION ---
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.onclick = () => switchTab(item.dataset.target);
        });

        function switchTab(tabId) {
            navItems.forEach(n => n.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-target="${tabId}"]`);
            if(activeNav) activeNav.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // --- VIDEO ---
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('video-overlay').style.display = 'block';
            document.getElementById('searching-overlay').style.display = 'flex';
            document.getElementById('zego-mount').innerHTML = '';
            findMatch();
        };

        document.getElementById('stop-btn').onclick = () => {
            if(zp) zp.destroy();
            if(isSearching) remove(ref(db, `queue/${currentUser.uid}`));
            isSearching = false;
            document.getElementById('video-overlay').style.display = 'none';
        };

        document.getElementById('next-btn').onclick = () => {
            if(zp) zp.destroy();
            if(isSearching) remove(ref(db, `queue/${currentUser.uid}`));
            document.getElementById('zego-mount').innerHTML = '';
            document.getElementById('searching-overlay').style.display = 'flex';
            findMatch();
        };

        document.getElementById('add-friend-btn').onclick = () => {
             if(currentPartnerId) {
                update(ref(db, `users/${currentUser.uid}/friends/${currentPartnerId}`), { timestamp: Date.now() });
                showToast("Friend Added Successfully!");
             } else {
                 showToast("Wait for a match!");
             }
        };

        async function findMatch() {
            if(isSearching) return;
            isSearching = true;
            currentPartnerId = null;

            const qRef = ref(db, 'queue');
            const snap = await get(qRef);
            let found = false;

            if(snap.exists()) {
                snap.forEach(c => {
                    if(c.key !== currentUser.uid && !found) {
                        found = true;
                        currentPartnerId = c.key;
                        const roomId = c.val().roomId;
                        remove(ref(db, `queue/${c.key}`)); 
                        startZego(roomId);
                    }
                });
            }

            if(!found) {
                const myRoom = `room_${currentUser.uid}_${Date.now()}`;
                await set(ref(db, `queue/${currentUser.uid}`), { roomId: myRoom });
                
                onValue(ref(db, `queue/${currentUser.uid}`), (s) => {
                    if(isSearching && !s.exists()) {
                        startZego(myRoom);
                    }
                });
            }
        }

        function startZego(roomID) {
            isSearching = false;
            document.getElementById('searching-overlay').style.display = 'none';
            
            const token = ZegoUIKitPrebuilt.generateKitTokenForTest(
                ZEGO_APP_ID, ZEGO_SERVER_SECRET, roomID, currentUser.uid, currentUser.displayName || "User"
            );
            
            zp = ZegoUIKitPrebuilt.create(token);
            zp.joinRoom({
                container: document.getElementById('zego-mount'),
                scenario: { mode: ZegoUIKitPrebuilt.OneONOneCall },
                showPreJoinView: false,
                turnOnCameraWhenJoining: true,
                turnOnMicrophoneWhenJoining: true,
                showLeaveRoomConfirmDialog: false,
                showUserList: false,
            });
        }

        // --- FRIENDS & CHAT ---
        function loadFriends() {
            const listRef = ref(db, `users/${currentUser.uid}/friends`);
            onValue(listRef, (snap) => {
                const mList = document.getElementById('messages-list');
                const fList = document.getElementById('friends-list');
                mList.innerHTML = ''; fList.innerHTML = '';
                let count = 0;

                if(snap.exists()) {
                    snap.forEach(c => {
                        count++;
                        const fid = c.key;
                        get(ref(db, `users/${fid}`)).then(uSnap => {
                            if(uSnap.exists()) {
                                const u = uSnap.val();
                                const html = `
                                    <div class="list-item" onclick="window.openChat('${fid}', '${u.displayName}')">
                                        <div style="position:relative">
                                            <img src="${u.customPhoto || u.photoURL}" class="list-img">
                                            <div class="status-dot"></div>
                                        </div>
                                        <div style="flex:1">
                                            <h4 style="font-weight:600">${u.displayName}</h4>
                                            <p style="font-size:0.8rem; color:#aaa;">Tap to start chat</p>
                                        </div>
                                        <i class="fas fa-chevron-right" style="color:#444"></i>
                                    </div>
                                `;
                                mList.innerHTML += html;
                                fList.innerHTML += html;
                            }
                        });
                    });
                } else {
                    const empty = '<p style="text-align:center; margin-top:50px; color:#444">No friends yet.<br>Start matching to make friends!</p>';
                    mList.innerHTML = empty;
                    fList.innerHTML = empty;
                }
                document.getElementById('friend-count').innerText = count;
            });
        }

        window.openChat = (fid, name) => {
            activeChatFriendId = fid;
            document.getElementById('chat-title').innerText = name;
            document.getElementById('chat-screen').classList.add('open');
            loadChat();
        };

        window.closeChat = () => {
            document.getElementById('chat-screen').classList.remove('open');
            activeChatFriendId = null;
        };

        function loadChat() {
            const cid = currentUser.uid < activeChatFriendId ? `${currentUser.uid}_${activeChatFriendId}` : `${activeChatFriendId}_${currentUser.uid}`;
            onValue(ref(db, `messages/${cid}`), (s) => {
                const b = document.getElementById('chat-body');
                b.innerHTML = '';
                if(s.exists()) {
                    s.forEach(c => {
                        const m = c.val();
                        const d = document.createElement('div');
                        d.className = `msg ${m.sender === currentUser.uid ? 'my-msg' : 'their-msg'}`;
                        d.innerText = m.text;
                        b.appendChild(d);
                    });
                    b.scrollTop = b.scrollHeight;
                }
            });
        }

        window.sendMsg = () => {
            const i = document.getElementById('chat-input');
            const txt = i.value.trim();
            if(!txt || !activeChatFriendId) return;
            const cid = currentUser.uid < activeChatFriendId ? `${currentUser.uid}_${activeChatFriendId}` : `${activeChatFriendId}_${currentUser.uid}`;
            push(ref(db, `messages/${cid}`), { sender: currentUser.uid, text: txt, ts: serverTimestamp() });
            i.value = '';
        };

        // --- UPLOAD ---
        document.getElementById('file-up').onchange = (e) => {
            const file = e.target.files[0];
            if(file) {
                const r = new FileReader();
                r.onload = () => {
                    update(ref(db, `users/${currentUser.uid}`), { customPhoto: r.result });
                    showToast("Profile Photo Updated!");
                    setTimeout(() => location.reload(), 1000);
                };
                r.readAsDataURL(file);
            }
        };
        
        // VIP
        document.getElementById('vip-btn').onclick = () => {
            var options = {
                "key": "rzp_live_SBirtJRkaeGMgl",
                "amount": "19900",
                "currency": "INR",
                "name": "ExploreMeet VIP",
                "description": "Premium Access",
                "handler": function (response) {
                    update(ref(db, `users/${currentUser.uid}`), { subscription: "VIP" })
                    .then(() => {
                        showToast("Welcome to VIP Club!");
                        document.getElementById('vip-badge').style.display = 'inline-block';
                    });
                }
            };
            new Razorpay(options).open();
        }

    </script>
</body>
</html>