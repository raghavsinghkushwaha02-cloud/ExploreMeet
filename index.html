<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMLive - Perfect App</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- THEME SETTINGS --- */
        :root {
            --bg-dark: #0a0a12;
            --primary-pink: #ff0055;
            --text-white: #ffffff;
            --card-bg: #151520;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; background-color: var(--bg-dark); color: var(--text-white); overflow: hidden; }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .glass-btn { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 50%; cursor: pointer; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; }

        /* --- 1. LOGIN SCREEN --- */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-btn { background: white; color: black; padding: 15px 40px; border-radius: 30px; font-weight: bold; border: none; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; cursor: pointer; }

        /* --- 2. MAIN APP --- */
        #app-container { height: 100%; display: flex; flex-direction: column; padding-bottom: 80px; }
        
        /* HEADER */
        .header { padding: 20px; font-size: 1.5rem; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        .brand { color: var(--primary-pink); }

        /* SCREENS */
        .screen-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; }
        
        /* HOME - RADAR */
        .home-center { align-items: center; justify-content: center; text-align: center; }
        .radar-box { position: relative; width: 260px; height: 260px; display: flex; justify-content: center; align-items: center; margin-bottom: 40px; }
        .my-avatar { width: 110px; height: 110px; border-radius: 50%; border: 4px solid white; object-fit: cover; z-index: 2; position: relative; }
        .pulse { position: absolute; border: 2px solid var(--primary-pink); width: 100%; height: 100%; border-radius: 50%; animation: pulse 2.5s infinite; opacity: 0; }
        .pulse:nth-child(2) { animation-delay: 0.8s; }
        @keyframes pulse { 0% { transform: scale(0.5); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }

        .start-btn { 
            background: linear-gradient(90deg, var(--primary-pink), #ff4444); color: white; border: none;
            padding: 18px 80px; border-radius: 50px; font-size: 1.4rem; font-weight: bold;
            box-shadow: 0 10px 30px rgba(255, 0, 85, 0.4); cursor: pointer;
        }

        /* LISTS (Friends/Messages) */
        .list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .list-item:active { background: rgba(255,255,255,0.05); }
        .u-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #333; }
        .u-info { flex: 1; }
        .u-name { font-weight: 600; font-size: 1.1rem; }
        .u-status { font-size: 0.8rem; color: #888; }
        .online { color: #2ecc71; }

        /* PROFILE */
        .profile-card { background: var(--card-bg); padding: 30px; border-radius: 20px; text-align: center; margin-top: 20px; }
        .logout-btn { background: transparent; border: 1px solid #ff4444; color: #ff4444; padding: 10px 30px; margin-top: 20px; border-radius: 20px; cursor: pointer; }

        /* NAVIGATION */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--bg-dark); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-icon { font-size: 1.5rem; color: #666; padding: 10px; cursor: pointer; transition: 0.2s; }
        .nav-icon.active { color: var(--primary-pink); transform: translateY(-5px); }

        /* --- 3. VIDEO CALL OVERLAY --- */
        #video-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; }
        #remote-video { width: 100%; height: 100%; }
        .video-overlay-ui { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 5001; }
        
        .v-header { margin-top: 40px; text-align: center; font-weight: 600; text-shadow: 0 2px 4px black; }
        .v-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: space-evenly; pointer-events: auto; }
        .ctrl-btn { width: 60px; height: 60px; font-size: 1.2rem; }
        .btn-end { background: var(--primary-pink); width: 75px; height: 75px; font-size: 2rem; }
        
        .add-friend-btn { position: absolute; top: 50px; right: 20px; width: 50px; height: 50px; pointer-events: auto; background: rgba(0,0,0,0.5); }

        #matching-loader { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(10,10,18,0.95); z-index: 5002; display: none; flex-direction: column; justify-content: center; align-items: center; }

        /* --- 4. CHAT OVERLAY --- */
        #chat-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 6000; display: none; flex-direction: column; }
        .chat-head { padding: 15px; background: var(--card-bg); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #333; }
        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 10px; background: var(--card-bg); display: flex; gap: 10px; }
        
        .msg { padding: 10px 15px; border-radius: 20px; max-width: 75%; word-wrap: break-word; font-size: 0.95rem; }
        .msg-me { background: var(--primary-pink); align-self: flex-end; border-bottom-right-radius: 5px; }
        .msg-other { background: #333; align-self: flex-start; border-bottom-left-radius: 5px; }
        
        .c-input { flex: 1; background: #0a0a12; border: none; padding: 12px 20px; border-radius: 25px; color: white; outline: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="margin-bottom: 40px; font-size: 2.5rem;">EM<span class="brand">Live</span></h1>
        <button class="login-btn" onclick="login()"><i class="fab fa-google"></i> Login with Google</button>
    </div>

    <div id="app-container" class="hidden">
        
        <div class="header">
            <span>EM<span class="brand">Live</span></span>
        </div>

        <div id="screen-home" class="screen-content home-center">
            <div class="radar-box">
                <div class="pulse"></div><div class="pulse"></div>
                <img id="home-dp" src="" class="my-avatar">
            </div>
            <h2 style="margin-bottom: 10px;">Find Match</h2>
            <p style="color: #888; margin-bottom: 50px;">Connect with random people</p>
            <button class="start-btn" onclick="startMatching()">START</button>
        </div>

        <div id="screen-friends" class="screen-content hidden">
            <h2 style="margin-bottom: 20px;">Friends & Chats</h2>
            <div id="friend-list-ui">
                <p style="text-align:center; color:#666; margin-top:50px;">Add friends in video call to chat!</p>
            </div>
        </div>

        <div id="screen-profile" class="screen-content hidden">
            <h2 style="margin-bottom: 20px;">My Profile</h2>
            <div class="profile-card">
                <img id="profile-dp" src="" class="my-avatar">
                <h2 id="profile-name" style="margin-top: 15px;">User</h2>
                <p id="profile-email" style="color: #888;">email@gmail.com</p>
                <button class="logout-btn" onclick="logout()">LOGOUT</button>
            </div>
        </div>

        <div class="bottom-nav">
            <i class="fas fa-fire nav-icon active" onclick="switchTab('home', this)"></i>
            <i class="fas fa-comment-dots nav-icon" onclick="switchTab('friends', this)"></i>
            <i class="fas fa-user nav-icon" onclick="switchTab('profile', this)"></i>
        </div>
    </div>

    <div id="video-screen">
        <div class="video-overlay-ui">
            <div class="v-header" id="v-status">Connected...</div>
            <div class="glass-btn add-friend-btn" onclick="addFriend()">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="v-controls">
                <button class="glass-btn ctrl-btn"><i class="fas fa-microphone-slash"></i></button>
                <button class="glass-btn btn-end" onclick="endCall()"><i class="fas fa-phone"></i></button>
                <button class="glass-btn ctrl-btn"><i class="fas fa-camera-rotate"></i></button>
            </div>
        </div>
        <div id="remote-video"></div> <div id="matching-loader">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--primary-pink);"></i>
            <p style="margin-top: 20px;">Searching...</p>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-head">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size: 1.2rem;"></i>
            <img id="chat-head-img" src="" style="width: 40px; height: 40px; border-radius: 50%;">
            <strong id="chat-head-name">User</strong>
        </div>
        <div id="chat-msgs" class="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" class="c-input" placeholder="Type message...">
            <button class="glass-btn" style="width: 45px; background: var(--primary-pink);" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, remove, push, get, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- REPLACE WITH YOUR FIREBASE KEYS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB6H5YFrr7gD7YmRsinknALrp5_RL3dLA",
            authDomain: "exploremeet---live.firebaseapp.com",
            databaseURL: "https://exploremeet---live-default-rtdb.firebaseio.com",
            projectId: "exploremeet---live",
            storageBucket: "exploremeet---live.firebasestorage.app",
            messagingSenderId: "169038218786",
            appId: "1:169038218786:web:4282137dbeb92000dbac7b"
        };
        const appID = 2013687880; 
        const serverSecret = "2576346c100ee42b720e88db26d01e53";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let zp = null; // Zego Instance
        let currentPartnerID = null;
        let myQueueKey = null;
        let activeChatID = null;

        // --- AUTH ---
        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                // Update UI
                document.getElementById('home-dp').src = user.photoURL;
                document.getElementById('profile-dp').src = user.photoURL;
                document.getElementById('profile-name').innerText = user.displayName;
                document.getElementById('profile-email').innerText = user.email;

                // Load Friends
                loadFriends();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        // --- NAVIGATION ---
        window.switchTab = (tab, el) => {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-'+tab).classList.remove('hidden');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        // --- MATCHING LOGIC ---
        window.startMatching = () => {
            document.getElementById('video-screen').style.display = 'block';
            document.getElementById('matching-loader').style.display = 'flex';
            
            const queueRef = ref(db, 'queue');
            get(queueRef).then((snap) => {
                let found = false;
                if(snap.exists()) {
                    snap.forEach(child => {
                        const data = child.val();
                        if(!found && data.uid !== currentUser.uid && !data.matched) {
                            found = true;
                            // Match found!
                            set(ref(db, `queue/${child.key}/matched`), currentUser.uid);
                            currentPartnerID = data.uid;
                            startVideo(child.key); // Use room ID
                        }
                    });
                }
                
                if(!found) {
                    // Create queue
                    myQueueKey = push(queueRef).key;
                    set(ref(db, `queue/${myQueueKey}`), { uid: currentUser.uid, matched: false });
                    
                    // Wait for match
                    onValue(ref(db, `queue/${myQueueKey}`), (s) => {
                        const d = s.val();
                        if(d && d.matched) {
                            currentPartnerID = d.matched;
                            startVideo(myQueueKey);
                            remove(ref(db, `queue/${myQueueKey}`)); // Clear queue
                            myQueueKey = null;
                        }
                    });
                    
                    // Cleanup on disconnect
                    onDisconnect(ref(db, `queue/${myQueueKey}`)).remove();
                }
            });
        };

        function startVideo(roomID) {
            document.getElementById('matching-loader').style.display = 'none';
            // Get Partner Name
            get(ref(db, `users/${currentPartnerID}`)).then(s => {
                const name = s.exists() ? s.val().displayName : "Stranger";
                document.getElementById('v-status').innerText = "Connected: " + name;
            });

            const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, currentUser.uid, currentUser.displayName);
            zp = ZegoUIKitPrebuilt.create(kitToken);
            zp.joinRoom({
                container: document.getElementById('remote-video'),
                scenario: { mode: ZegoUIKitPrebuilt.OneONoneCall },
                showPreJoinView: false,
                showLeavingView: false,
                onLeaveRoom: () => window.endCall()
            });
        }

        window.endCall = () => {
            if(zp) zp.destroy();
            if(myQueueKey) remove(ref(db, `queue/${myQueueKey}`));
            document.getElementById('video-screen').style.display = 'none';
        };

        // --- FRIEND & CHAT ---
        window.addFriend = () => {
            if(currentPartnerID) {
                // Add to my friends
                update(ref(db, `users/${currentUser.uid}/friends/${currentPartnerID}`), { since: Date.now() });
                // Add me to their friends
                update(ref(db, `users/${currentPartnerID}/friends/${currentUser.uid}`), { since: Date.now() });
                alert("Friend Added!");
            }
        };

        function loadFriends() {
            onValue(ref(db, `users/${currentUser.uid}/friends`), async (snap) => {
                const list = document.getElementById('friend-list-ui');
                list.innerHTML = "";
                
                if(snap.exists()) {
                    const ids = Object.keys(snap.val());
                    for(const uid of ids) {
                        // Fetch details
                        const uSnap = await get(ref(db, `users/${uid}`));
                        if(uSnap.exists()) { // Check if user exists in DB
                            const u = uSnap.val();
                            // If user details are missing (e.g. newly created via queue), use defaults or fetch from auth data if stored
                            // Note: For this to work perfectly, you need to save user data on login (added below)
                             
                             const name = u.displayName || "Unknown User";
                             const pic = u.photoURL || "https://via.placeholder.com/50";

                            const div = document.createElement('div');
                            div.className = 'list-item';
                            div.innerHTML = `
                                <img src="${pic}" class="u-avatar">
                                <div class="u-info">
                                    <div class="u-name">${name}</div>
                                    <div class="u-status">Tap to chat</div>
                                </div>
                                <i class="fas fa-comment-dots" style="color:#666"></i>
                            `;
                            div.onclick = () => openChat(uid, name, pic);
                            list.appendChild(div);
                        }
                    }
                } else {
                    list.innerHTML = `<p style="text-align:center; color:#666; margin-top:50px;">No friends yet.</p>`;
                }
            });
        }
        
        // Save User Data on Login (Crucial for Chat)
        onAuthStateChanged(auth, (user) => {
            if(user) {
                update(ref(db, `users/${user.uid}`), {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL
                });
            }
        });

        // --- CHAT LOGIC ---
        window.openChat = (uid, name, pic) => {
            activeChatID = uid;
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-head-name').innerText = name;
            document.getElementById('chat-head-img').src = pic;
            
            // Load Messages
            const room = [currentUser.uid, uid].sort().join('_');
            onValue(ref(db, `chats/${room}`), (snap) => {
                const box = document.getElementById('chat-msgs');
                box.innerHTML = "";
                if(snap.exists()) {
                    snap.forEach(c => {
                        const m = c.val();
                        const isMe = m.sender === currentUser.uid;
                        box.innerHTML += `<div class="msg ${isMe ? 'msg-me' : 'msg-other'}">${m.text}</div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                }
            });
        };

        window.closeChat = () => {
            document.getElementById('chat-screen').style.display = 'none';
            activeChatID = null;
        };

        window.sendMsg = () => {
            const txt = document.getElementById('msg-input').value.trim();
            if(txt && activeChatID) {
                const room = [currentUser.uid, activeChatID].sort().join('_');
                push(ref(db, `chats/${room}`), {
                    sender: currentUser.uid,
                    text: txt,
                    time: Date.now()
                });
                document.getElementById('msg-input').value = "";
            }
        };

    </script>
</body>
</html>
